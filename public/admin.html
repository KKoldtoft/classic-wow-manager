<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Panel - Classic WoW Manager</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        

        
        .management-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .permission-card, .settings-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }
        
        .management-section {
            border-left-color: #e74c3c;
        }
        
        .admin-user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        h1, h2, h3, h4, h5 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        h2 {
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #3498db;
        }
        
        p {
            color: #7f8c8d;
            line-height: 1.6;
        }
        
        .role-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .role-badge.admin {
            background: #e74c3c;
        }
        
        .role-badge.manager {
            background: #f39c12;
        }
        
        .access-denied {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn.danger {
            background: #e74c3c;
        }
        
        .btn.danger:hover {
            background: #c0392b;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container, .management-panel {
                padding: 10px;
            }
            
            .permission-card, .settings-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Universal Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="/images/1p_logo.png" alt="1Principles" class="app-logo" width="110" height="30">
            <nav class="top-nav">
                <a href="/" class="top-nav-link">Home</a>
                <div class="top-nav-dropdown">
                    <button class="top-nav-link dropdown-toggle" id="upcoming-raids-dropdown">
                        Upcoming Raids <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="upcoming-raids-menu">
                        <div class="dropdown-loading">Loading raids...</div>
                    </div>
                </div>
                <a href="/guild-members" class="top-nav-link">Guild Members</a>
                <a href="/attendance" class="top-nav-link">Regular Attendance</a>
            </nav>
        </div>
        <div id="auth-container">
            <!-- Auth content is now loaded by top-bar.js -->
        </div>
    </div>

    <!-- Active Raid Bar (shown when raid is selected) -->
    <div class="raid-bar" id="raid-bar" style="display: none;">
        <div class="raid-bar-left">
            <span class="raid-title" id="raid-title">Loading...</span>
            <nav class="raid-nav">
                <a href="#" class="raid-nav-link" id="raid-roster-link">
                    <i class="fas fa-users"></i> Roster
                </a>
                <a href="#" class="raid-nav-link" id="raid-assignments-link">
                    <i class="fas fa-tasks"></i> Assignments
                </a>
                <a href="/raidlogs" class="raid-nav-link" id="raid-logs-link">
                    <i class="fas fa-chart-line"></i> Raid Logs
                </a>
                <a href="/gold" class="raid-nav-link" id="raid-goldpot-link">
                    <i class="fas fa-coins"></i> Gold Pot
                </a>
                <a href="/loot" class="raid-nav-link" id="raid-loot-link">
                    <i class="fas fa-shield-alt"></i> Loot
                </a>
            </nav>
        </div>
        <div class="raid-bar-right">
            <button class="raid-close-btn" onclick="localStorage.removeItem('activeEventSession'); location.reload();">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="container">
        <div class="management-panel">
            <h1>Management Panel</h1>
        
        <div id="loading" class="loading">
            <p>Loading user permissions...</p>
        </div>
        
        <div id="access-denied" class="access-denied" style="display: none;">
            <h2>Access Denied</h2>
            <p>You need to be logged in with Discord and have the "Management" role to access this panel.</p>
            <a href="/auth/discord?returnTo=%2Fadmin" class="btn">Login with Discord</a>
        </div>
        
        <div id="management-content" style="display: none;">
            <div id="user-info" class="admin-user-info">
                <!-- User info will be loaded here -->
            </div>
            
            <!-- Management-only section -->
            <div id="management-section" class="permission-card management-section" style="display: none;">
                <h2>üî¥ Management Features</h2>
                <p>You have Management role access. These features are only available to users with the "Management" role.</p>
                <button class="btn" onclick="loadAllUsers()">Load All Users</button>
                <button class="btn" onclick="loadRosterStats()">Load Roster Statistics</button>
                <button class="btn danger" onclick="setupDatabase()">Setup Database</button>
                <button class="btn" onclick="createTemplatesTable()">Create Templates Table</button>
                <button class="btn danger" onclick="showManagementTools()">Management Tools</button>
                <div id="management-data"></div>
            </div>
            
            <!-- Guild Import section -->
            <div id="guild-import-section" class="permission-card management-section" style="display: none;">
                <h2>üè∞ Guild Import</h2>
                <p>Import guild member data from a semicolon-separated export. Only level 60 characters will be imported.</p>
                
                <div style="margin-bottom: 20px;">
                    <label for="guild-import-data" style="display: block; margin-bottom: 10px; font-weight: 600;">
                        Paste your guild export data here:
                    </label>
                    <textarea 
                        id="guild-import-data" 
                        placeholder="Name;Rank;Level;Class;Race;Sex;Last Online (Days);Main/Alt;Player Alts;Join Date;Promo Date;Rank History;Birthday;Public Note;Officer Note;Custom Note;Faction&#10;Aezra;GDKP Regular;60;Mage;Undead;Female;39;;;;;;;Tamatori;;;Horde"
                        style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"
                    ></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="previewGuildImport()" id="preview-btn">
                        <i class="fas fa-eye"></i> Preview Import
                    </button>
                    <button class="btn danger" onclick="executeGuildImport()" id="execute-btn" style="display: none;">
                        <i class="fas fa-upload"></i> Execute Import
                    </button>
                </div>
                
                <div id="guild-import-preview" style="display: none;">
                    <!-- Preview content will be loaded here -->
                </div>
                
                <div id="guild-import-result" style="display: none;">
                    <!-- Import result will be loaded here -->
                </div>
            </div>
            
            <!-- Channel Filter section -->
            <div id="channel-filter-section" class="permission-card management-section" style="display: none;">
                <h2>üì° Filter Raids by Discord Channel</h2>
                <p>Control which Discord channels should show raids in the upcoming raids list and events page. This affects both upcoming and completed raids.</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadChannelFilters()" id="load-channels-btn">
                        <i class="fas fa-refresh"></i> Load Channels from Upcoming & Completed Raids
                    </button>
                    <button class="btn" onclick="saveChannelFilters()" id="save-filters-btn" style="display: none;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                
                <div id="channel-filters-content">
                    <!-- Channel filters will be loaded here -->
                </div>
            </div>

            <!-- Attendance Channel Filter section -->
            <div id="attendance-channel-filter-section" class="permission-card management-section" style="display: none;">
                <h2>üìÖ Regular Attendance Channel Filter</h2>
                <p>Control which Discord channels should be included in the Regular Attendance tracking. Events from filtered-out channels will not appear in attendance statistics.</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadAttendanceChannelFilters()" id="load-attendance-channels-btn">
                        <i class="fas fa-refresh"></i> Load Channels from Log Data
                    </button>
                    <button class="btn" onclick="saveAttendanceChannelFilters()" id="save-attendance-filters-btn" style="display: none;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                
                <div id="attendance-channel-filters-content">
                    <!-- Attendance channel filters will be loaded here -->
                </div>
            </div>

            <!-- Rewards and Deductions section -->
            <div id="rewards-section" class="permission-card management-section" style="display: none;">
                <h2>üèÜ Rewards and Deductions</h2>
                <p>Configure point calculations and limits for different raid performance categories.</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadRewardSettings()" id="load-rewards-btn">
                        <i class="fas fa-cog"></i> Load Current Settings
                    </button>
                    <button class="btn" onclick="saveRewardSettings()" id="save-rewards-btn" style="display: none;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                
                <div id="rewards-content">
                    <!-- Reward settings will be loaded here -->
                </div>
            </div>

            <!-- Channel Background Images section -->
            <div id="channel-backgrounds-section" class="permission-card management-section" style="display: none;">
                <h2>üñºÔ∏è Channel Background Images</h2>
                <p>Upload and manage background images for each Discord channel. Images will be shown in color for upcoming raids and black & white for completed raids.</p>
                
                <!-- Background Blur Control -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6f42c1;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">
                        <i class="fas fa-adjust"></i> Background Blur Settings
                    </h4>
                    <p style="color: #6c757d; margin-bottom: 15px;">
                        Apply a blur effect to all background images. This affects both upcoming and completed raids.
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="font-weight: 600; color: #495057;">Blur Intensity:</label>
                        <input 
                            type="range" 
                            id="blur-slider" 
                            min="0" 
                            max="10" 
                            step="0.5" 
                            value="0"
                            style="flex: 1; max-width: 200px;"
                            oninput="updateBlurPreview(this.value)"
                        >
                        <input 
                            type="number" 
                            id="blur-input" 
                            min="0" 
                            max="10" 
                            step="0.5" 
                            value="0"
                            style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                            oninput="updateBlurFromInput(this.value)"
                        >
                        <span style="color: #6c757d; font-size: 12px;">px</span>
                        <button 
                            class="btn" 
                            onclick="saveBlurSetting()" 
                            id="save-blur-btn"
                            style="min-width: 100px;"
                        >
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                    <div id="blur-status" style="margin-top: 10px; font-size: 14px;"></div>
                </div>
                
                <!-- Background Darken Control -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">
                        <i class="fas fa-moon"></i> Background Darken Settings
                    </h4>
                    <p style="color: #6c757d; margin-bottom: 15px;">
                        Apply a darkening effect to all background images. Lower values make backgrounds darker. This affects both upcoming and completed raids.
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="font-weight: 600; color: #495057;">Brightness:</label>
                        <input 
                            type="range" 
                            id="darken-slider" 
                            min="50" 
                            max="100" 
                            step="5" 
                            value="100"
                            style="flex: 1; max-width: 200px;"
                            oninput="updateDarkenPreview(this.value)"
                        >
                        <input 
                            type="number" 
                            id="darken-input" 
                            min="50" 
                            max="100" 
                            step="5" 
                            value="100"
                            style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                            oninput="updateDarkenFromInput(this.value)"
                        >
                        <span style="color: #6c757d; font-size: 12px;">%</span>
                        <button 
                            class="btn" 
                            onclick="saveDarkenSetting()" 
                            id="save-darken-btn"
                            style="min-width: 100px;"
                        >
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                    <div id="darken-status" style="margin-top: 10px; font-size: 14px;"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadChannelBackgrounds()" id="load-backgrounds-btn">
                        <i class="fas fa-images"></i> Load Channel Backgrounds
                    </button>
                </div>
                
                <div id="channel-backgrounds-content">
                    <!-- Channel background settings will be loaded here -->
                </div>
            </div>

            <!-- Class/Spec Mapping Viewer (Management) -->
            <div id="class-spec-mapping-section" class="permission-card management-section" style="display: none;">
                <h2 style="display:flex;align-items:center;gap:8px;cursor:pointer;" onclick="toggleClassSpecMappingPanel()">
                    <i class="fas fa-clipboard-list"></i>
                    Class / Spec Mapping
                    <span id="class-spec-fold-icon" style="margin-left:auto;color:#6c757d;font-size:14px;">(click to expand)</span>
                </h2>
                <div id="class-spec-mapping-panel" style="display:none;">
                    <p style="color:#7f8c8d;">Debug panel: view the static class/spec ‚Üí role/icon/color mapping stored in the database.</p>
                    <div style="margin-bottom: 12px;">
                        <button class="btn" id="load-class-spec-btn" onclick="loadClassSpecMappings()">
                            <i class="fas fa-download"></i> Load Mapping
                        </button>
                    </div>
                    <div id="class-spec-mapping-content"></div>
                </div>
            </div>

            <!-- Regular user section -->
            <div id="user-section" class="permission-card">
                <h2>üë§ User Features</h2>
                <p>Basic features available to all authenticated users.</p>
                <button class="btn" onclick="loadMyCharacters()">My Characters</button>
                <div id="user-data"></div>
            </div>
        </div>
    </div>

    <script src="top-bar.js"></script>
    <script>
        let currentUser = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkUserPermissions();
        });

        async function checkUserPermissions() {
            try {
                const response = await fetch('/user');
                const user = await response.json();
                
                if (!user.loggedIn) {
                    showAccessDenied();
                    return;
                }
                
                currentUser = user;
                showManagementContent(user);
                
            } catch (error) {
                console.error('Error checking permissions:', error);
                showAccessDenied();
            }
        }

        function showAccessDenied() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
        }

        function showManagementContent(user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('management-content').style.display = 'block';
            
            // Show user info
            const userInfoHtml = `
                <h3>Welcome, ${user.username}#${user.discriminator}</h3>
                <p><strong>Discord ID:</strong> ${user.id}</p>
                <p><strong>Email:</strong> ${user.email || 'Not provided'}</p>
                <p><strong>Management Role:</strong> ${user.hasManagementRole ? '‚úÖ Yes' : '‚ùå No'}</p>
            `;
            document.getElementById('user-info').innerHTML = userInfoHtml;
            
            // Show management section if user has Management role
            if (user.hasManagementRole) {
                document.getElementById('management-section').style.display = 'block';
                document.getElementById('guild-import-section').style.display = 'block';
                document.getElementById('channel-filter-section').style.display = 'block';
                document.getElementById('attendance-channel-filter-section').style.display = 'block';
                document.getElementById('rewards-section').style.display = 'block';
                document.getElementById('channel-backgrounds-section').style.display = 'block';
                document.getElementById('class-spec-mapping-section').style.display = 'block';
            }
        }

        function toggleClassSpecMappingPanel() {
            const panel = document.getElementById('class-spec-mapping-panel');
            const icon = document.getElementById('class-spec-fold-icon');
            const isHidden = panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? '(click to collapse)' : '(click to expand)';
        }

        async function loadClassSpecMappings() {
            const content = document.getElementById('class-spec-mapping-content');
            const btn = document.getElementById('load-class-spec-btn');
            content.innerHTML = '<div class="loading">Loading class/spec mappings...</div>';
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            try {
                const resp = await fetch('/api/admin/class-spec-mappings');
                const data = await resp.json();
                if (!resp.ok || !data.success) {
                    content.innerHTML = `<div class="access-denied">Error loading mappings: ${data.message || 'Unknown error'}</div>`;
                    return;
                }
                renderClassSpecMappings(data.mappings || []);
            } catch (e) {
                console.error('Error loading class/spec mappings:', e);
                content.innerHTML = '<div class="access-denied">Network error while loading mappings.</div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> Load Mapping';
            }
        }

        function renderClassSpecMappings(rows) {
            const content = document.getElementById('class-spec-mapping-content');
            if (!rows.length) {
                content.innerHTML = `
                    <div style="background:#fff3cd;border:1px solid #ffeaa7;padding:15px;border-radius:8px;color:#856404;">
                        No mappings found. Run "Setup Database" to seed the table.
                    </div>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Spec</th>
                        <th>Role</th>
                        <th>Spec Icon</th>
                        <th>Class Icon</th>
                        <th>Class Color</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(r => `
                        <tr>
                            <td>${r.class_name}</td>
                            <td>${r.spec_name}</td>
                            <td>${r.role}</td>
                            <td>${r.spec_icon_url ? `<img src="${r.spec_icon_url}" alt="spec" style="width:22px;height:22px;border-radius:4px;">` : ''}</td>
                            <td>${r.class_icon_url ? `<img src="${r.class_icon_url}" alt="class" style="width:22px;height:22px;border-radius:4px;">` : ''}</td>
                            <td>
                                <span style="display:inline-flex;align-items:center;gap:8px;">
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;border:1px solid #e0e0e0;background:${r.class_color_hex || '#ffffff'}"></span>
                                    <code style="color:#6c757d;">${r.class_color_hex || ''}</code>
                                </span>
                            </td>
                        </tr>`).join('')}
                </tbody>`;
            content.innerHTML = '';
            content.appendChild(table);
        }

        async function loadAllUsers() {
            try {
                const response = await fetch('/api/management/users');
                const data = await response.json();
                
                if (response.status === 403) {
                    document.getElementById('management-data').innerHTML = '<p class="access-denied">Access denied. Management role required.</p>';
                    return;
                }
                
                if (response.ok) {
                    const tableHtml = `
                        <h4>All Users (${data.users.length} total)</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Discord ID</th>
                                    <th>Character Name</th>
                                    <th>Class</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr>
                                        <td>${user.discord_id}</td>
                                        <td>${user.character_name}</td>
                                        <td>${user.class}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('management-data').innerHTML = tableHtml;
                } else {
                    document.getElementById('management-data').innerHTML = '<p>Error loading users: ' + data.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('management-data').innerHTML = '<p>Error loading users.</p>';
            }
        }

        async function loadRosterStats() {
            try {
                const response = await fetch('/api/management/roster-stats');
                const data = await response.json();
                
                if (response.status === 403) {
                    document.getElementById('management-data').innerHTML = '<p class="access-denied">Access denied. Management role required.</p>';
                    return;
                }
                
                if (response.ok) {
                    const statsHtml = `
                        <h4>Roster Statistics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div class="admin-user-info">
                                <h5>Managed Events</h5>
                                <p style="font-size: 24px; margin: 0;">${data.stats.managed_events}</p>
                            </div>
                            <div class="admin-user-info">
                                <h5>Total Roster Entries</h5>
                                <p style="font-size: 24px; margin: 0;">${data.stats.total_roster_entries}</p>
                            </div>
                            <div class="admin-user-info">
                                <h5>Unique Players</h5>
                                <p style="font-size: 24px; margin: 0;">${data.stats.unique_players}</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('management-data').innerHTML = statsHtml;
                } else {
                    document.getElementById('management-data').innerHTML = '<p>Error loading stats: ' + data.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading roster stats:', error);
                document.getElementById('management-data').innerHTML = '<p>Error loading roster statistics.</p>';
            }
        }

        async function loadMyCharacters() {
            try {
                const response = await fetch('/api/my-characters');
                const characters = await response.json();
                
                if (response.ok && characters.length > 0) {
                    const charactersHtml = `
                        <h4>My Characters (${characters.length} total)</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Character Name</th>
                                    <th>Class</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${characters.map(char => `
                                    <tr>
                                        <td>${char.character_name}</td>
                                        <td>${char.class}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('user-data').innerHTML = charactersHtml;
                } else {
                    document.getElementById('user-data').innerHTML = '<p>No characters found or error loading characters.</p>';
                }
            } catch (error) {
                console.error('Error loading characters:', error);
                document.getElementById('user-data').innerHTML = '<p>Error loading characters.</p>';
            }
        }

        async function setupDatabase() {
            if (!confirm('This will create/update all database tables including the new log_data table. Continue?')) {
                return;
            }
            
            const managementData = document.getElementById('management-data');
            managementData.innerHTML = '<div class="loading">Setting up database tables...</div>';
            
            try {
                const response = await fetch('/api/admin/setup-database', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    managementData.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 20px; border-radius: 8px; color: #155724; margin-top: 15px;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ Database Setup Successful!</h4>
                            <p style="margin: 0;">${data.message}</p>
                            <ul style="margin-top: 10px;">
                                <li>Players table created/updated</li>
                                <li>Roster overrides table created/updated</li>
                                <li>Player confirmed logs table created/updated</li>
                                <li><strong>Log data table created/updated</strong> ‚ú®</li>
                                <li>Guildies table created/updated</li>
                                <li>Sheet imports table created/updated</li>
                                <li>Sheet player abilities table created/updated</li>
                                <li><strong>Sheet players buffs table created/updated</strong> üåç</li>
                                <li>Events cache table created/updated</li>
                                <li>RPB tracking table created/updated</li>
                                <li><strong>Analysis type support added to RPB tracking</strong> üåçüßä</li>
                                <li><strong>Channel filters table created/updated</strong> üì°</li>
                        <li><strong>Attendance cache table created/updated</strong> üìÖ</li>
                        <li><strong>Attendance channel filters table created/updated</strong> üéØ</li>
                                <li><strong>Reward settings table created/updated</strong> üèÜ</li>
                                <li><strong>Channel backgrounds table created/updated</strong> üñºÔ∏è</li>
                                <li><strong>Manual rewards/deductions table created/updated</strong> ‚öñÔ∏è</li>
                                <li><strong>Manual rewards templates table created/updated</strong> üìã</li>
                                <li><strong>Player role mapping table created/updated (with primary_role calculation)</strong> üéØ</li>
                                <li><strong>Class/spec mapping table created/updated</strong> üß≠</li>
                                <li><strong>Background blur setting added</strong> üå´Ô∏è</li>
                    <li><strong>Background darken setting added</strong> üåô</li>
                    <li><strong>Text shadows added to event cards</strong> ‚ú®</li>
                                <li>All indexes created/updated</li>
                            </ul>
                        </div>
                    `;
                } else {
                    managementData.innerHTML = `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24; margin-top: 15px;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå Database Setup Failed</h4>
                            <p style="margin: 0;">Error: ${data.message || 'Unknown error occurred'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error setting up database:', error);
                managementData.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24; margin-top: 15px;">
                        <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå Database Setup Failed</h4>
                        <p style="margin: 0;">Network error occurred. Please try again.</p>
                    </div>
                `;
            }
        }

        async function createTemplatesTable() {
            if (!confirm('This will create the manual rewards templates table with default tank role templates. Continue?')) {
                return;
            }
            
            const managementData = document.getElementById('management-data');
            managementData.innerHTML = '<div class="loading">Creating templates table...</div>';
            
            try {
                const response = await fetch('/api/admin/create-templates-table', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    managementData.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 20px; border-radius: 8px; color: #155724; margin-top: 15px;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ Templates Table Created Successfully!</h4>
                            <p style="margin: 0;">${data.message}</p>
                            <ul style="margin-top: 10px;">
                                <li><strong>Templates table created/updated</strong> üìã</li>
                                <li><strong>Templates index created</strong> üîç</li>
                                <li><strong>Default tank role templates added (${data.templatesCount} templates)</strong> üõ°Ô∏è</li>
                                <li>Main Tank (100 pts)</li>
                                <li>Off Tank 1 (80 pts)</li>
                                <li>Off Tank 2 (50 pts)</li>
                                <li>Off Tank 3 (30 pts)</li>
                            </ul>
                            <p style="margin-top: 10px; font-weight: bold;">‚úÖ You can now use "Add from templates" on the raid logs page!</p>
                        </div>
                    `;
                } else {
                    managementData.innerHTML = `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24; margin-top: 15px;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå Templates Table Creation Failed</h4>
                            <p style="margin: 0;">Error: ${data.message || 'Unknown error occurred'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error creating templates table:', error);
                managementData.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24; margin-top: 15px;">
                        <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå Templates Table Creation Failed</h4>
                        <p style="margin: 0;">Network error occurred. Please try again.</p>
                    </div>
                `;
            }
        }

        function showManagementTools() {
            alert('This would show management tools like user management, roster management, event management, system settings, etc.');
        }

        async function previewGuildImport() {
            const importData = document.getElementById('guild-import-data').value.trim();
            const previewDiv = document.getElementById('guild-import-preview');
            const executeBtn = document.getElementById('execute-btn');
            const resultDiv = document.getElementById('guild-import-result');
            
            // Hide previous results
            executeBtn.style.display = 'none';
            resultDiv.style.display = 'none';
            
            if (!importData) {
                previewDiv.innerHTML = '<div class="access-denied">Please paste guild export data first.</div>';
                previewDiv.style.display = 'block';
                return;
            }

            previewDiv.innerHTML = '<div class="loading">Analyzing import data...</div>';
            previewDiv.style.display = 'block';

            try {
                const response = await fetch('/api/management/guild-import-preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ importData })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    let previewHtml = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: #2c3e50;">üìä Import Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="text-align: center; background: white; padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 24px; color: #3498db; font-weight: bold;">${data.summary.totalImported}</div>
                                    <div style="color: #7f8c8d;">Total Level 60s</div>
                                </div>
                                <div style="text-align: center; background: white; padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 24px; color: #27ae60; font-weight: bold;">${data.summary.toAdd}</div>
                                    <div style="color: #7f8c8d;">To Add</div>
                                </div>
                                <div style="text-align: center; background: white; padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 24px; color: #e74c3c; font-weight: bold;">${data.summary.toRemove}</div>
                                    <div style="color: #7f8c8d;">To Remove</div>
                                </div>
                                <div style="text-align: center; background: white; padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 24px; color: #f39c12; font-weight: bold;">${data.summary.toUpdate}</div>
                                    <div style="color: #7f8c8d;">To Update</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Warning</h4>
                            <p style="color: #856404; margin: 0;">
                                This will completely replace your current guild roster. 
                                <strong>${data.summary.toAdd} members will be added</strong>, 
                                <strong>${data.summary.toRemove} members will be removed</strong>, and 
                                <strong>${data.summary.toUpdate} members will be updated</strong>.
                            </p>
                        </div>
                    `;

                    // Show characters to be added
                    if (data.changes.toAdd.length > 0) {
                        previewHtml += `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #27ae60;">‚úÖ Members to be Added (${data.changes.toAdd.length})</h4>
                                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                                    <table class="data-table" style="margin: 0;">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Class</th>
                                                <th>Rank</th>
                                                <th>Discord Link</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.changes.toAdd.map(char => `
                                                <tr>
                                                    <td>${char.character_name}</td>
                                                    <td>${char.class}</td>
                                                    <td>${char.rank_name}</td>
                                                    <td>${char.discord_id ? '‚úÖ Linked' : '‚ùå Not linked'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }

                    // Show characters to be removed
                    if (data.changes.toRemove.length > 0) {
                        previewHtml += `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #e74c3c;">‚ùå Members to be Removed (${data.changes.toRemove.length})</h4>
                                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                                    <table class="data-table" style="margin: 0;">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Class</th>
                                                <th>Current Rank</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.changes.toRemove.map(char => `
                                                <tr>
                                                    <td>${char.character_name}</td>
                                                    <td>${char.class}</td>
                                                    <td>${char.rank_name}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }

                    // Show characters to be updated
                    if (data.changes.toUpdate.length > 0) {
                        previewHtml += `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #f39c12;">üîÑ Members to be Updated (${data.changes.toUpdate.length})</h4>
                                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                                    <table class="data-table" style="margin: 0;">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Class</th>
                                                <th>Changes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.changes.toUpdate.map(change => {
                                                const changedFields = [];
                                                const old = change.changes.old;
                                                const newChar = change.changes.new;
                                                
                                                if (old.rank_name !== newChar.rank_name) changedFields.push(`Rank: ${old.rank_name} ‚Üí ${newChar.rank_name}`);
                                                if (old.last_online_days !== newChar.last_online_days) changedFields.push(`Last Online: ${old.last_online_days} ‚Üí ${newChar.last_online_days} days`);
                                                if (old.officer_note !== newChar.officer_note) changedFields.push(`Officer Note: "${old.officer_note}" ‚Üí "${newChar.officer_note}"`);
                                                if (old.discord_id !== newChar.discord_id) changedFields.push(`Discord: ${old.discord_id ? 'Linked' : 'Not linked'} ‚Üí ${newChar.discord_id ? 'Linked' : 'Not linked'}`);
                                                
                                                return `
                                                    <tr>
                                                        <td>${change.character_name}</td>
                                                        <td>${newChar.class}</td>
                                                        <td style="font-size: 12px;">${changedFields.join('<br>')}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }

                    previewDiv.innerHTML = previewHtml;
                    executeBtn.style.display = 'inline-flex';
                    
                } else {
                    previewDiv.innerHTML = `<div class="access-denied">Error: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error previewing guild import:', error);
                previewDiv.innerHTML = '<div class="access-denied">Error previewing guild import. Please try again.</div>';
            }
        }

        async function executeGuildImport() {
            const importData = document.getElementById('guild-import-data').value.trim();
            const resultDiv = document.getElementById('guild-import-result');
            const executeBtn = document.getElementById('execute-btn');
            
            if (!confirm('Are you sure you want to execute this guild import? This will replace all current guild data.')) {
                return;
            }

            executeBtn.disabled = true;
            executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
            
            resultDiv.innerHTML = '<div class="loading">Executing guild import...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch('/api/management/guild-import-execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ importData })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 20px; border-radius: 8px; color: #155724;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ Import Successful!</h4>
                            <p style="margin: 0;">${data.message}</p>
                        </div>
                    `;
                    
                    // Clear the form
                    document.getElementById('guild-import-data').value = '';
                    document.getElementById('guild-import-preview').style.display = 'none';
                    executeBtn.style.display = 'none';
                    
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå Import Failed</h4>
                            <p style="margin: 0;">Error: ${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error executing guild import:', error);
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24;">
                        <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå Import Failed</h4>
                        <p style="margin: 0;">Network error occurred. Please try again.</p>
                    </div>
                `;
            } finally {
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<i class="fas fa-upload"></i> Execute Import';
            }
        }

        // ====================================
        // CHANNEL FILTER FUNCTIONS
        // ====================================

        async function loadChannelFilters() {
            const contentDiv = document.getElementById('channel-filters-content');
            const loadBtn = document.getElementById('load-channels-btn');
            const saveBtn = document.getElementById('save-filters-btn');
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            contentDiv.innerHTML = '<div class="loading">Loading channels from upcoming and completed raids...</div>';

            try {
                const response = await fetch('/api/admin/channel-filters');
                const data = await response.json();

                if (response.ok && data.success) {
                    renderChannelFilters(data.channels);
                    saveBtn.style.display = 'inline-flex';
                } else {
                    contentDiv.innerHTML = `<div class="access-denied">Error loading channels: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading channel filters:', error);
                contentDiv.innerHTML = '<div class="access-denied">Network error occurred while loading channels.</div>';
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-refresh"></i> Load Channels from Upcoming & Completed Raids';
            }
        }

        function renderChannelFilters(channels) {
            const contentDiv = document.getElementById('channel-filters-content');
            
            if (!channels || channels.length === 0) {
                contentDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; color: #856404;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üì≠ No Channels Found</h4>
                        <p style="margin: 0;">No raids with Discord channels were found in upcoming or completed events. Please ensure there are events in the system.</p>
                    </div>
                `;
                return;
            }

            let filtersHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">üìä Channel Filter Settings</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">
                        Toggle channels below to show or hide raids from those channels. 
                        Hidden channels will not appear in the upcoming raids dropdown, events page, or completed raids panel.
                        <br><strong>Note:</strong> Changes affect all users globally.
                    </p>
                </div>
                
                <div style="display: grid; gap: 15px;">
            `;

            channels.forEach(channel => {
                const isVisible = channel.is_visible !== false; // Default to true if not set
                const toggleClass = isVisible ? 'toggle-on' : 'toggle-off';
                const statusText = isVisible ? 'Shown' : 'Hidden';
                const statusColor = isVisible ? '#28a745' : '#dc3545';

                filtersHTML += `
                    <div class="channel-filter-item" data-channel-id="${channel.channel_id}">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: 8px; border: 1px solid #dee2e6;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">
                                    <i class="fas fa-hashtag" style="color: #7289da; margin-right: 5px;"></i>
                                    ${channel.channel_name || `Channel ${channel.channel_id}`}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">
                                    ID: ${channel.channel_id} ‚Ä¢ ${channel.raid_count || 0} total raids
                                    ${channel.upcoming_count ? `<br>üìÖ ${channel.upcoming_count} upcoming` : ''}
                                    ${channel.historic_count ? `<br>üìö ${channel.historic_count} completed` : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="color: ${statusColor}; font-weight: 500; min-width: 60px;">
                                    ${statusText}
                                </span>
                                <div class="channel-toggle ${toggleClass}" data-channel-id="${channel.channel_id}" onclick="toggleChannel('${channel.channel_id}')">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            filtersHTML += `</div>`;

            contentDiv.innerHTML = filtersHTML;

            // Add CSS for toggles if not already added
            if (!document.getElementById('channel-toggle-styles')) {
                const style = document.createElement('style');
                style.id = 'channel-toggle-styles';
                style.textContent = `
                    .channel-toggle {
                        width: 50px;
                        height: 25px;
                        background: #ccc;
                        border-radius: 25px;
                        position: relative;
                        cursor: pointer;
                        transition: background 0.3s;
                    }
                    
                    .channel-toggle.toggle-on {
                        background: #28a745;
                    }
                    
                    .channel-toggle.toggle-off {
                        background: #dc3545;
                    }
                    
                    .toggle-slider {
                        width: 21px;
                        height: 21px;
                        background: white;
                        border-radius: 50%;
                        position: absolute;
                        top: 2px;
                        transition: transform 0.3s;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    
                    .toggle-on .toggle-slider {
                        transform: translateX(25px);
                    }
                    
                    .toggle-off .toggle-slider {
                        transform: translateX(2px);
                    }
                    
                    .channel-filter-item:hover {
                        transform: translateY(-1px);
                        transition: transform 0.2s;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function toggleChannel(channelId) {
            const toggle = document.querySelector(`.channel-toggle[data-channel-id="${channelId}"]`);
            const statusSpan = toggle.closest('.channel-filter-item').querySelector('span[style*="color:"]');
            
            if (toggle.classList.contains('toggle-on')) {
                // Turn off
                toggle.classList.remove('toggle-on');
                toggle.classList.add('toggle-off');
                statusSpan.textContent = 'Hidden';
                statusSpan.style.color = '#dc3545';
            } else {
                // Turn on
                toggle.classList.remove('toggle-off');
                toggle.classList.add('toggle-on');
                statusSpan.textContent = 'Shown';
                statusSpan.style.color = '#28a745';
            }
            
            // Show save button to indicate changes need saving
            document.getElementById('save-filters-btn').style.display = 'inline-flex';
        }

        async function saveChannelFilters() {
            const saveBtn = document.getElementById('save-filters-btn');
            const toggles = document.querySelectorAll('.channel-toggle');
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            // Collect filter settings
            const filterSettings = [];
            toggles.forEach(toggle => {
                const channelId = toggle.dataset.channelId;
                const isVisible = toggle.classList.contains('toggle-on');
                filterSettings.push({
                    channel_id: channelId,
                    is_visible: isVisible
                });
            });

            try {
                const response = await fetch('/api/admin/channel-filters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filters: filterSettings
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show success message
                    const contentDiv = document.getElementById('channel-filters-content');
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        background: #d4edda;
                        border: 1px solid #c3e6cb;
                        color: #155724;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        animation: slideIn 0.3s ease;
                    `;
                    successMsg.innerHTML = `
                        <h4 style="color: #155724; margin: 0 0 5px 0;">‚úÖ Settings Saved!</h4>
                        <p style="margin: 0;">Channel filter settings have been updated successfully. Changes will take effect immediately.</p>
                    `;
                    contentDiv.insertBefore(successMsg, contentDiv.firstChild);

                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);

                    saveBtn.style.display = 'none';
                } else {
                    alert(`Error saving filters: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving channel filters:', error);
                alert('Network error occurred while saving filters.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        // ATTENDANCE CHANNEL FILTER FUNCTIONS
        // ====================================
        
        async function loadAttendanceChannelFilters() {
            const contentDiv = document.getElementById('attendance-channel-filters-content');
            const loadBtn = document.getElementById('load-attendance-channels-btn');
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            contentDiv.innerHTML = '<p>Loading attendance channels...</p>';
            
            try {
                const response = await fetch('/api/admin/attendance-channel-filters');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                renderAttendanceChannelFilters(data.channels);
                
                document.getElementById('save-attendance-filters-btn').style.display = 'inline-block';
            } catch (error) {
                console.error('Error loading attendance channel filters:', error);
                contentDiv.innerHTML = `
                    <div class="alert alert-error">
                        <p><strong>Error loading attendance channels:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-refresh"></i> Load Channels from Log Data';
            }
        }

        function renderAttendanceChannelFilters(channels) {
            const contentDiv = document.getElementById('attendance-channel-filters-content');
            
            if (channels.length === 0) {
                contentDiv.innerHTML = `
                    <div class="alert alert-info">
                        <p>No channels found in attendance log data. Make sure you have attendance data populated first.</p>
                    </div>
                `;
                return;
            }

            const channelsHtml = `
                <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 15px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">üìÖ Attendance Channel Filter Settings</h4>
                    <p style="margin-bottom: 20px; color: #7f8c8d;">
                        Toggle channels to control which raids are included in attendance tracking. 
                        Disabled channels will be excluded from all attendance calculations.
                    </p>
                    <div style="display: grid; gap: 12px;">
                        ${channels.map(channel => {
                            const isIncluded = channel.is_included !== false; // Default to true if not set
                            return `
                                <div class="attendance-channel-filter-item" data-channel-id="${channel.channel_id}">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="font-weight: 600; color: ${isIncluded ? '#27ae60' : '#e74c3c'};">${channel.channel_name}</span>
                                            <span style="font-size: 12px; color: #7f8c8d; font-family: monospace;">${channel.channel_id}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 14px; color: ${isIncluded ? '#27ae60' : '#e74c3c'};">
                                                ${isIncluded ? '‚úÖ Included' : '‚ùå Excluded'}
                                            </span>
                                            <label class="switch">
                                                <input type="checkbox" ${isIncluded ? 'checked' : ''} onchange="toggleAttendanceChannelFilter(this)">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            contentDiv.innerHTML = channelsHtml;
        }

        function toggleAttendanceChannelFilter(toggle) {
            const isChecked = toggle.checked;
            const statusSpan = toggle.closest('.attendance-channel-filter-item').querySelector('span[style*="color:"]');
            
            if (isChecked) {
                statusSpan.textContent = '‚úÖ Included';
                statusSpan.style.color = '#27ae60';
                // Update the channel name color too
                const channelNameSpan = toggle.closest('.attendance-channel-filter-item').querySelector('span[style*="font-weight"]');
                channelNameSpan.style.color = '#27ae60';
            } else {
                statusSpan.textContent = '‚ùå Excluded';
                statusSpan.style.color = '#e74c3c';
                // Update the channel name color too
                const channelNameSpan = toggle.closest('.attendance-channel-filter-item').querySelector('span[style*="font-weight"]');
                channelNameSpan.style.color = '#e74c3c';
            }
            
            // Show save button
            document.getElementById('save-attendance-filters-btn').style.display = 'inline-block';
        }

        async function saveAttendanceChannelFilters() {
            const saveBtn = document.getElementById('save-attendance-filters-btn');
            
            // Collect filter states
            const filters = [];
            document.querySelectorAll('.attendance-channel-filter-item').forEach(item => {
                const channelId = item.dataset.channelId;
                const isIncluded = item.querySelector('input[type="checkbox"]').checked;
                filters.push({ channelId, isIncluded });
            });

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const response = await fetch('/api/admin/attendance-channel-filters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filters })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    const contentDiv = document.getElementById('attendance-channel-filters-content');
                    const successMsg = document.createElement('div');
                    successMsg.className = 'alert alert-success';
                    successMsg.style.marginTop = '15px';
                    successMsg.innerHTML = `
                        <p style="margin: 0;">Attendance channel filter settings have been updated successfully. 
                        Attendance tracking will now respect these filter settings.</p>
                    `;
                    contentDiv.appendChild(successMsg);

                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);

                    saveBtn.style.display = 'none';
                } else {
                    alert(`Error saving attendance filters: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving attendance channel filters:', error);
                alert('Network error occurred while saving attendance filters.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        // ====================================
        // REWARD SETTINGS FUNCTIONS
        // ====================================

        async function loadRewardSettings() {
            const contentDiv = document.getElementById('rewards-content');
            const loadBtn = document.getElementById('load-rewards-btn');
            const saveBtn = document.getElementById('save-rewards-btn');
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            contentDiv.innerHTML = '<div class="loading">Loading reward settings...</div>';

            try {
                const response = await fetch('/api/admin/reward-settings');
                const data = await response.json();

                if (response.ok && data.success) {
                    renderRewardSettings(data.settings);
                    saveBtn.style.display = 'inline-flex';
                } else {
                    contentDiv.innerHTML = `<div class="access-denied">Error loading settings: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading reward settings:', error);
                contentDiv.innerHTML = '<div class="access-denied">Network error occurred while loading settings.</div>';
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-cog"></i> Load Current Settings';
            }
        }

        function renderRewardSettings(settings) {
            const contentDiv = document.getElementById('rewards-content');
            
            if (!settings || Object.keys(settings).length === 0) {
                contentDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; color: #856404;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üì≠ No Settings Found</h4>
                        <p style="margin: 0;">No reward settings found in the database. Please run database setup first.</p>
                    </div>
                `;
                return;
            }

            let settingsHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">‚öôÔ∏è Reward Configuration</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">
                        Configure how points are calculated and awarded for different performance categories.
                        <br><strong>Note:</strong> Changes take effect immediately on all raid logs pages.
                    </p>
                </div>
            `;

            // Abilities settings
            if (settings.abilities) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #ff6b35; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_bomb_06.jpg" style="width: 24px; height: 24px;"> 
                            Engineering & Holywater
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Calculation Divisor
                                </label>
                                <input 
                                    type="number" 
                                    id="abilities-calculation-divisor" 
                                    value="${settings.abilities.calculation_divisor.value}" 
                                    min="1" 
                                    max="100" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Formula: (abilities used √ó avg targets) √∑ divisor
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Maximum Points
                                </label>
                                <input 
                                    type="number" 
                                    id="abilities-max-points" 
                                    value="${settings.abilities.max_points.value}" 
                                    min="1" 
                                    max="500" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #ff6b35;">
                            <strong>Description:</strong> ${settings.abilities.calculation_divisor.description}
                        </div>
                    </div>
                `;
            }

            // Damage settings
            if (settings.damage) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #dc3545; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-sword"></i> 
                            Damage Dealers
                        </h4>
                        
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                Points for Each Position
                            </label>
                            <textarea 
                                id="damage-points-array" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical;"
                                rows="3"
                                onchange="markRewardsChanged()"
                                placeholder="80, 70, 55, 40, 35, 30, 25, 20, 15, 10, 8, 6, 5, 4, 3"
                            >${settings.damage.points_array.value.join(', ')}</textarea>
                            <small style="color: #6c757d; display: block; margin-top: 4px;">
                                Enter points separated by commas (e.g., "80, 70, 55"). Position 1 gets first value, position 2 gets second value, etc.
                            </small>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545; margin-top: 15px;">
                            <strong>Description:</strong> ${settings.damage.points_array.description}
                        </div>
                    </div>
                `;
            }

            // Healing settings
            if (settings.healing) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-heart"></i> 
                            Healers
                        </h4>
                        
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                Points for Each Position
                            </label>
                            <textarea 
                                id="healing-points-array" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical;"
                                rows="2"
                                onchange="markRewardsChanged()"
                                placeholder="80, 65, 60, 55, 40, 35, 30, 20, 15, 10"
                            >${settings.healing.points_array.value.join(', ')}</textarea>
                            <small style="color: #6c757d; display: block; margin-top: 4px;">
                                Enter points separated by commas (e.g., "80, 65, 60"). Position 1 gets first value, position 2 gets second value, etc.
                            </small>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745; margin-top: 15px;">
                            <strong>Description:</strong> ${settings.healing.points_array.description}
                        </div>
                    </div>
                `;
            }

            // Mana Potions settings
            if (settings.mana_potions) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #4a9eff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_potion_76.jpg" style="width: 20px; height: 20px;"> 
                            Major Mana Potions
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Minimum Threshold
                                </label>
                                <input 
                                    type="number" 
                                    id="mana-threshold" 
                                    value="${settings.mana_potions.threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Potions below this count earn 0 points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Points Per Potion
                                </label>
                                <input 
                                    type="number" 
                                    id="mana-points-per-potion" 
                                    value="${settings.mana_potions.points_per_potion.value}" 
                                    min="0.1" 
                                    max="50" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points earned per potion above threshold
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Maximum Points
                                </label>
                                <input 
                                    type="number" 
                                    id="mana-max-points" 
                                    value="${settings.mana_potions.max_points.value}" 
                                    min="1" 
                                    max="500" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #4a9eff;">
                            <strong>Formula:</strong> Points = min(max_points, (potions_used - threshold) √ó points_per_potion)
                            <br><strong>Description:</strong> ${settings.mana_potions.threshold.description}
                        </div>
                    </div>
                `;
            }

            // Runes settings
            if (settings.runes) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #8b5cf6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_sealofkings.jpg" style="width: 20px; height: 20px;"> 
                            Dark or Demonic runes
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    You get <span style="color: #8b5cf6;">X</span> points
                                </label>
                                <input 
                                    type="number" 
                                    id="runes-points-earned" 
                                    value="${settings.runes.points_per_division.value}" 
                                    min="0.1" 
                                    max="10" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points awarded per rune threshold reached
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Per <span style="color: #8b5cf6;">Y</span> runes used
                                </label>
                                <input 
                                    type="number" 
                                    id="runes-threshold" 
                                    value="${settings.runes.usage_divisor.value}" 
                                    min="1" 
                                    max="20" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Number of runes needed to earn points
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #8b5cf6;">
                            <strong>Example:</strong> If you set "1 point per 2 runes", then 2 runes = 1 point, 4 runes = 2 points, 5 runes = 2 points
                            <br><strong>Formula:</strong> Points = floor(total_runes √∑ runes_threshold) √ó points_earned
                        </div>
                    </div>
                `;
            }

            // Interrupts settings
            if (settings.interrupts) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #f59e0b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_kick.jpg" style="width: 20px; height: 20px;"> 
                            Interrupted spells
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    You get <span style="color: #f59e0b;">X</span> points
                                </label>
                                <input 
                                    type="number" 
                                    id="interrupts-points-earned" 
                                    value="${settings.interrupts.points_per_interrupt.value}" 
                                    min="0.1" 
                                    max="10" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points awarded per interrupt threshold reached
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Per <span style="color: #f59e0b;">Y</span> interrupts
                                </label>
                                <input 
                                    type="number" 
                                    id="interrupts-threshold" 
                                    value="${settings.interrupts.interrupts_needed.value}" 
                                    min="1" 
                                    max="10" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Number of interrupts needed to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Maximum Points
                                </label>
                                <input 
                                    type="number" 
                                    id="interrupts-max-points" 
                                    value="${settings.interrupts.max_points.value}" 
                                    min="1" 
                                    max="50" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                            <strong>Example:</strong> If you set "1 point per 1 interrupt, max 5", then 1 interrupt = 1 point, 5 interrupts = 5 points, 8 interrupts = 5 points (capped)
                            <br><strong>Formula:</strong> Points = min(max_points, floor(interrupts √∑ threshold) √ó points_earned)
                        </div>
                    </div>
                `;
            }

            // Disarms settings
            if (settings.disarms) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #dc3545; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_warrior_disarm.jpg" style="width: 20px; height: 20px;"> 
                            Disarmed enemies
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    You get <span style="color: #dc3545;">X</span> points
                                </label>
                                <input 
                                    type="number" 
                                    id="disarms-points-earned" 
                                    value="${settings.disarms.points_per_disarm.value}" 
                                    min="0.1" 
                                    max="10" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points awarded per disarm threshold reached
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Per <span style="color: #dc3545;">Y</span> disarms
                                </label>
                                <input 
                                    type="number" 
                                    id="disarms-threshold" 
                                    value="${settings.disarms.disarms_needed.value}" 
                                    min="1" 
                                    max="10" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Number of disarms needed to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Maximum Points
                                </label>
                                <input 
                                    type="number" 
                                    id="disarms-max-points" 
                                    value="${settings.disarms.max_points.value}" 
                                    min="1" 
                                    max="50" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <strong>Example:</strong> If you set "1 point per 1 disarm, max 5", then 1 disarm = 1 point, 5 disarms = 5 points, 8 disarms = 5 points (capped)
                            <br><strong>Formula:</strong> Points = min(max_points, floor(disarms √∑ threshold) √ó points_earned)
                        </div>
                    </div>
                `;
            }

            // Sunder Armor settings
            if (settings.sunder) {
                const ranges = settings.sunder.point_ranges.value || [];
                let rangesHTML = '';
                
                ranges.forEach((range, index) => {
                    rangesHTML += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #e9ecef; border-radius: 4px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Min Count</label>
                                <input 
                                    type="number" 
                                    id="sunder-range-${index}-min" 
                                    value="${range.min}" 
                                    min="0" 
                                    max="999"
                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;"
                                    onchange="markRewardsChanged()"
                                >
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Max Count</label>
                                <input 
                                    type="number" 
                                    id="sunder-range-${index}-max" 
                                    value="${range.max}" 
                                    min="0" 
                                    max="999"
                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;"
                                    onchange="markRewardsChanged()"
                                >
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Points</label>
                                <input 
                                    type="number" 
                                    id="sunder-range-${index}-points" 
                                    value="${range.points}" 
                                    min="-50" 
                                    max="50"
                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;"
                                    onchange="markRewardsChanged()"
                                >
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Color</label>
                                <select 
                                    id="sunder-range-${index}-color" 
                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;"
                                    onchange="markRewardsChanged()"
                                >
                                    <option value="red" ${range.color === 'red' ? 'selected' : ''}>Red</option>
                                    <option value="gray" ${range.color === 'gray' ? 'selected' : ''}>Gray</option>
                                    <option value="green" ${range.color === 'green' ? 'selected' : ''}>Green</option>
                                    <option value="blue" ${range.color === 'blue' ? 'selected' : ''}>Blue</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #6f42c1; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_warrior_sunder.jpg" style="width: 20px; height: 20px;"> 
                            Sunder Armor
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                Point Ranges
                            </label>
                            <div id="sunder-ranges-container">
                                ${rangesHTML}
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #6f42c1;">
                            <strong>How it works:</strong> Players are awarded points based on their Sunder Armor count falling into these ranges.
                            <br><strong>Note:</strong> Negative points (red) will be displayed in red text. Zero points (gray) mean no reward or penalty.
                        </div>
                    </div>
                `;
            }

            // Curse of Recklessness settings
            if (settings.curse) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #8b5cf6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_unholystrength.jpg" style="width: 24px; height: 24px;"> 
                            Curse of Recklessness
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-uptime-threshold" 
                                    value="${settings.curse.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-points" 
                                    value="${settings.curse.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #8b5cf6;">
                            <strong>Description:</strong> ${settings.curse.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Curse of Shadow settings
            if (settings.curse_shadow) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #6b46c1; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_curseofachimonde.jpg" style="width: 24px; height: 24px;"> 
                            Curse of Shadow
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-shadow-uptime-threshold" 
                                    value="${settings.curse_shadow.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-shadow-points" 
                                    value="${settings.curse_shadow.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #6b46c1;">
                            <strong>Description:</strong> ${settings.curse_shadow.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Curse of the Elements settings
            if (settings.curse_elements) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #3b82f6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_chilltouch.jpg" style="width: 24px; height: 24px;"> 
                            Curse of the Elements
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-elements-uptime-threshold" 
                                    value="${settings.curse_elements.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-elements-points" 
                                    value="${settings.curse_elements.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                            <strong>Description:</strong> ${settings.curse_elements.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Faerie Fire settings
            if (settings.faerie_fire) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #10b981; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_nature_faeriefire.jpg" style="width: 24px; height: 24px;"> 
                            Faerie Fire
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="faerie-fire-uptime-threshold" 
                                    value="${settings.faerie_fire.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="faerie-fire-points" 
                                    value="${settings.faerie_fire.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #10b981;">
                            <strong>Description:</strong> ${settings.faerie_fire.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Scorch settings
            if (settings.scorch) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #dc3545; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_fire_soulburn.jpg" style="width: 24px; height: 24px;"> 
                            Scorch
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 1 Max (0 points)
                                </label>
                                <input 
                                    type="number" 
                                    id="scorch-tier1-max" 
                                    value="${settings.scorch.tier1_max.value}" 
                                    min="0" 
                                    max="999" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Max scorch count for 0 points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 2 Max
                                </label>
                                <input 
                                    type="number" 
                                    id="scorch-tier2-max" 
                                    value="${settings.scorch.tier2_max.value}" 
                                    min="0" 
                                    max="999" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Max for tier 2 points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 2 Points
                                </label>
                                <input 
                                    type="number" 
                                    id="scorch-tier2-points" 
                                    value="${settings.scorch.tier2_points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points for mid-tier
                                </small>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 3 Points (High Tier)
                                </label>
                                <input 
                                    type="number" 
                                    id="scorch-tier3-points" 
                                    value="${settings.scorch.tier3_points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points for highest tier (above tier 2 max)
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <strong>Description:</strong> ${settings.scorch.tier1_max.description}
                        </div>
                    </div>
                `;
            }

            // Demoralizing Shout settings
            if (settings.demo_shout) {
                settingsHTML += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #d2691e; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_warrior_warcry.jpg" style="width: 24px; height: 24px;"> 
                            Demoralizing Shout
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 1 Max (0 points)
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier1-max" 
                                    value="${settings.demo_shout.tier1_max.value}" 
                                    min="0" 
                                    max="999" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Max demo shout count for 0 points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 2 Max
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier2-max" 
                                    value="${settings.demo_shout.tier2_max.value}" 
                                    min="0" 
                                    max="999" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Max for tier 2 points
                                </small>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 2 Points
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier2-points" 
                                    value="${settings.demo_shout.tier2_points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points for mid-tier
                                </small>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                    Tier 3 Points (High Tier)
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier3-points" 
                                    value="${settings.demo_shout.tier3_points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    onchange="markRewardsChanged()"
                                >
                                <small style="color: #6c757d; display: block; margin-top: 4px;">
                                    Points for highest tier (above tier 2 max)
                                </small>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #d2691e;">
                            <strong>Description:</strong> ${settings.demo_shout.tier1_max.description}
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = settingsHTML;
        }

        function markRewardsChanged() {
            document.getElementById('save-rewards-btn').style.display = 'inline-flex';
        }

        function collectSunderRanges() {
        const ranges = [];
        const container = document.getElementById('sunder-ranges-container');
        if (!container) return ranges;
        
        const rangeElements = container.querySelectorAll('[id^="sunder-range-"]');
        const rangeIndexes = new Set();
        
        // Extract unique range indexes
        rangeElements.forEach(element => {
            const match = element.id.match(/sunder-range-(\d+)-/);
            if (match) {
                rangeIndexes.add(parseInt(match[1]));
            }
        });
        
        // Collect data for each range
        rangeIndexes.forEach(index => {
            const minElement = document.getElementById(`sunder-range-${index}-min`);
            const maxElement = document.getElementById(`sunder-range-${index}-max`);
            const pointsElement = document.getElementById(`sunder-range-${index}-points`);
            const colorElement = document.getElementById(`sunder-range-${index}-color`);
            
            if (minElement && maxElement && pointsElement && colorElement) {
                ranges.push({
                    min: parseInt(minElement.value),
                    max: parseInt(maxElement.value),
                    points: parseInt(pointsElement.value),
                    color: colorElement.value
                });
            }
        });
        
        // Sort ranges by min value
        ranges.sort((a, b) => a.min - b.min);
        
        return ranges;
    }

    async function saveRewardSettings() {
            const saveBtn = document.getElementById('save-rewards-btn');
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            // Helper function to parse array from textarea
            function parsePointsArray(textareaId) {
                const text = document.getElementById(textareaId).value.trim();
                if (!text) return [];
                return text.split(',').map(val => parseInt(val.trim())).filter(val => !isNaN(val));
            }

            // Collect settings from form
            const settings = {
                abilities: {
                    calculation_divisor: parseFloat(document.getElementById('abilities-calculation-divisor').value),
                    max_points: parseInt(document.getElementById('abilities-max-points').value)
                },
                damage: {
                    points_array: parsePointsArray('damage-points-array')
                },
                healing: {
                    points_array: parsePointsArray('healing-points-array')
                },
                mana_potions: {
                    threshold: parseInt(document.getElementById('mana-threshold').value),
                    points_per_potion: parseFloat(document.getElementById('mana-points-per-potion').value),
                    max_points: parseInt(document.getElementById('mana-max-points').value)
                },
                runes: {
                    usage_divisor: parseInt(document.getElementById('runes-threshold').value),
                    points_per_division: parseFloat(document.getElementById('runes-points-earned').value)
                },
                interrupts: {
                    points_per_interrupt: parseFloat(document.getElementById('interrupts-points-earned').value),
                    interrupts_needed: parseInt(document.getElementById('interrupts-threshold').value),
                    max_points: parseInt(document.getElementById('interrupts-max-points').value)
                },
                disarms: {
                    points_per_disarm: parseFloat(document.getElementById('disarms-points-earned').value),
                    disarms_needed: parseInt(document.getElementById('disarms-threshold').value),
                    max_points: parseInt(document.getElementById('disarms-max-points').value)
                },
                sunder: {
                    point_ranges: collectSunderRanges()
                },
                curse: {
                    uptime_threshold: parseFloat(document.getElementById('curse-uptime-threshold').value),
                    points: parseInt(document.getElementById('curse-points').value)
                },
                curse_shadow: {
                    uptime_threshold: parseFloat(document.getElementById('curse-shadow-uptime-threshold').value),
                    points: parseInt(document.getElementById('curse-shadow-points').value)
                },
                curse_elements: {
                    uptime_threshold: parseFloat(document.getElementById('curse-elements-uptime-threshold').value),
                    points: parseInt(document.getElementById('curse-elements-points').value)
                }
            };

            // Only include settings if the corresponding input fields exist (defensive checks)
            const faerieFireThreshold = document.getElementById('faerie-fire-uptime-threshold');
            if (faerieFireThreshold) {
                settings.faerie_fire = {
                    uptime_threshold: parseFloat(faerieFireThreshold.value),
                    points: parseInt(document.getElementById('faerie-fire-points').value)
                };
            }

            const scorchTier1Max = document.getElementById('scorch-tier1-max');
            if (scorchTier1Max) {
                settings.scorch = {
                    tier1_max: parseInt(scorchTier1Max.value),
                    tier1_points: 0, // Always 0 for tier 1
                    tier2_max: parseInt(document.getElementById('scorch-tier2-max').value),
                    tier2_points: parseInt(document.getElementById('scorch-tier2-points').value),
                    tier3_points: parseInt(document.getElementById('scorch-tier3-points').value)
                };
            }

            const demoShoutTier1Max = document.getElementById('demo-shout-tier1-max');
            if (demoShoutTier1Max) {
                settings.demo_shout = {
                    tier1_max: parseInt(demoShoutTier1Max.value),
                    tier1_points: 0, // Always 0 for tier 1
                    tier2_max: parseInt(document.getElementById('demo-shout-tier2-max').value),
                    tier2_points: parseInt(document.getElementById('demo-shout-tier2-points').value),
                    tier3_points: parseInt(document.getElementById('demo-shout-tier3-points').value)
                };
            }

            try {
                const response = await fetch('/api/admin/reward-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        settings: settings
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show success message
                    const contentDiv = document.getElementById('rewards-content');
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        background: #d4edda;
                        border: 1px solid #c3e6cb;
                        color: #155724;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        animation: slideIn 0.3s ease;
                    `;
                    successMsg.innerHTML = `
                        <h4 style="color: #155724; margin: 0 0 5px 0;">‚úÖ Settings Saved!</h4>
                        <p style="margin: 0;">Reward settings have been updated successfully. Changes are now active on all raid logs pages.</p>
                    `;
                    contentDiv.insertBefore(successMsg, contentDiv.firstChild);

                    // Remove success message after 4 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 4000);

                    saveBtn.style.display = 'none';
                } else {
                    alert(`Error saving settings: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving reward settings:', error);
                alert('Network error occurred while saving settings.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        // ====================================
        // CHANNEL BACKGROUNDS FUNCTIONS
        // ====================================

        async function loadChannelBackgrounds() {
            const contentDiv = document.getElementById('channel-backgrounds-content');
            const loadBtn = document.getElementById('load-backgrounds-btn');
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            contentDiv.innerHTML = '<div class="loading">Loading channel backgrounds...</div>';

            try {
                // Get all channels from events first
                const channelsResponse = await fetch('/api/admin/channel-filters');
                const channelsData = await channelsResponse.json();
                
                // Get existing backgrounds
                const backgroundsResponse = await fetch('/api/admin/channel-backgrounds');
                const backgroundsData = await backgroundsResponse.json();
                
                // Load current blur and darken settings
                await loadBlurSetting();
                await loadDarkenSetting();
                
                if (channelsData.success && backgroundsData.success) {
                    renderChannelBackgrounds(channelsData.channels, backgroundsData.backgrounds);
                } else {
                    contentDiv.innerHTML = `<div class="access-denied">Error loading data: ${channelsData.message || backgroundsData.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading channel backgrounds:', error);
                contentDiv.innerHTML = '<div class="access-denied">Network error occurred while loading channel backgrounds.</div>';
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-images"></i> Load Channel Backgrounds';
            }
        }

        // Background blur control functions
        async function loadBlurSetting() {
            try {
                const response = await fetch('/api/ui/background-blur');
                const data = await response.json();
                
                if (data.success) {
                    const blurValue = data.blurValue || 0;
                    document.getElementById('blur-slider').value = blurValue;
                    document.getElementById('blur-input').value = blurValue;
                    updateBlurPreview(blurValue);
                }
            } catch (error) {
                console.error('Error loading blur setting:', error);
            }
        }

        function updateBlurPreview(value) {
            const numValue = parseFloat(value);
            document.getElementById('blur-slider').value = numValue;
            document.getElementById('blur-input').value = numValue;
            
            // Apply blur to any visible preview images in the admin panel
            const previews = document.querySelectorAll('[style*="background-image"]');
            previews.forEach(preview => {
                if (preview.style.backgroundImage && preview.style.backgroundImage.includes('url(')) {
                    if (numValue > 0) {
                        preview.style.filter = `blur(${numValue}px)`;
                    } else {
                        preview.style.filter = '';
                    }
                }
            });
        }

        function updateBlurFromInput(value) {
            updateBlurPreview(value);
        }

        async function saveBlurSetting() {
            const blurValue = parseFloat(document.getElementById('blur-input').value);
            const saveBtn = document.getElementById('save-blur-btn');
            const statusDiv = document.getElementById('blur-status');
            
            if (isNaN(blurValue) || blurValue < 0 || blurValue > 10) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Blur value must be between 0 and 10</span>';
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            statusDiv.innerHTML = '<span style="color: #6c757d;">Saving blur setting...</span>';

            try {
                const response = await fetch('/api/admin/background-blur', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ blurValue })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Blur setting saved successfully! Refresh pages to see the effect.</span>';
                    
                    // Clear success message after 3 seconds
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error: ${data.message}</span>`;
                }
            } catch (error) {
                console.error('Error saving blur setting:', error);
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Network error occurred while saving blur setting.</span>';
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        }

        // Background darken control functions
        async function loadDarkenSetting() {
            try {
                const response = await fetch('/api/ui/background-darken');
                const data = await response.json();
                
                if (data.success) {
                    const darkenValue = data.darkenValue || 100;
                    document.getElementById('darken-slider').value = darkenValue;
                    document.getElementById('darken-input').value = darkenValue;
                    updateDarkenPreview(darkenValue);
                }
            } catch (error) {
                console.error('Error loading darken setting:', error);
            }
        }

        function updateDarkenPreview(value) {
            const numValue = parseFloat(value);
            document.getElementById('darken-slider').value = numValue;
            document.getElementById('darken-input').value = numValue;
            
            // Apply darken to any visible preview images in the admin panel
            const previews = document.querySelectorAll('[style*="background-image"]');
            previews.forEach(preview => {
                if (preview.style.backgroundImage && preview.style.backgroundImage.includes('url(')) {
                    if (numValue < 100) {
                        const existingFilter = preview.style.filter || '';
                        // Remove any existing brightness filter and add the new one
                        const filterWithoutBrightness = existingFilter.replace(/brightness\([^)]*\)\s*/g, '').trim();
                        const newFilter = filterWithoutBrightness ? 
                            `${filterWithoutBrightness} brightness(${numValue}%)` : 
                            `brightness(${numValue}%)`;
                        preview.style.filter = newFilter;
                    } else {
                        // Remove brightness filter but keep other filters
                        const existingFilter = preview.style.filter || '';
                        const filterWithoutBrightness = existingFilter.replace(/brightness\([^)]*\)\s*/g, '').trim();
                        preview.style.filter = filterWithoutBrightness;
                    }
                }
            });
        }

        function updateDarkenFromInput(value) {
            updateDarkenPreview(value);
        }

        async function saveDarkenSetting() {
            const darkenValue = parseFloat(document.getElementById('darken-input').value);
            const saveBtn = document.getElementById('save-darken-btn');
            const statusDiv = document.getElementById('darken-status');
            
            if (isNaN(darkenValue) || darkenValue < 50 || darkenValue > 100) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Darken value must be between 50 and 100</span>';
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            statusDiv.innerHTML = '<span style="color: #6c757d;">Saving darken setting...</span>';

            try {
                const response = await fetch('/api/admin/background-darken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ darkenValue })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Darken setting saved successfully! Refresh pages to see the effect.</span>';
                    
                    // Clear success message after 3 seconds
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error: ${data.message}</span>`;
                }
            } catch (error) {
                console.error('Error saving darken setting:', error);
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Network error occurred while saving darken setting.</span>';
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        }

        function renderChannelBackgrounds(channels, backgrounds) {
            const contentDiv = document.getElementById('channel-backgrounds-content');
            
            if (!channels || channels.length === 0) {
                contentDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; color: #856404;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üì≠ No Channels Found</h4>
                        <p style="margin: 0;">No channels found. Please load some raids first to detect channels.</p>
                    </div>
                `;
                return;
            }

            // Create a map of existing backgrounds
            const backgroundsMap = {};
            backgrounds.forEach(bg => {
                backgroundsMap[bg.channel_id] = bg;
            });

            let backgroundsHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">üñºÔ∏è Channel Background Settings</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">
                        Upload background images for each Discord channel. Images will be shown in full color for upcoming raids 
                        and in black & white for completed raids. Supported formats: JPG, PNG, GIF, WebP (max 10MB).
                    </p>
                </div>
                
                <div style="display: grid; gap: 20px;">
            `;

            channels.forEach(channel => {
                const channelName = channel.channel_name || `Channel ${channel.channel_id}`;
                const existingBackground = backgroundsMap[channel.channel_id];
                
                backgroundsHTML += `
                    <div class="channel-background-item" data-channel-id="${channel.channel_id}">
                        <div style="background: white; border-radius: 8px; border: 1px solid #dee2e6; overflow: hidden;">
                            <div style="padding: 20px; border-bottom: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="margin: 0; color: #2c3e50;">
                                            <i class="fas fa-hashtag" style="color: #7289da; margin-right: 5px;"></i>
                                            ${channelName}
                                        </h4>
                                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #6c757d; font-family: monospace;">ID: ${channel.channel_id}</p>
                                    </div>
                                    ${existingBackground ? `
                                        <button class="btn danger" onclick="deleteChannelBackground('${channel.channel_id}', '${channelName}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    ` : ''}
                                </div>
                                
                                ${existingBackground ? `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; gap: 20px;">
                                            <div style="flex: 1;">
                                                <h5 style="margin: 0 0 10px 0; color: #495057;">Current Background (Color - Upcoming Raids)</h5>
                                                <div style="
                                                    width: 200px; 
                                                    height: 120px; 
                                                    background-image: url('${existingBackground.background_image_url}'); 
                                                    background-size: cover; 
                                                    background-position: center;
                                                    border-radius: 6px;
                                                    border: 2px solid #dee2e6;
                                                "></div>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="margin: 0 0 10px 0; color: #495057;">Preview (B&W - Completed Raids)</h5>
                                                <div style="
                                                    width: 200px; 
                                                    height: 120px; 
                                                    background-image: url('${existingBackground.background_image_url}'); 
                                                    background-size: cover; 
                                                    background-position: center;
                                                    border-radius: 6px;
                                                    border: 2px solid #dee2e6;
                                                    filter: grayscale(100%);
                                                "></div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div>
                                    <h5 style="margin: 0 0 10px 0; color: #495057;">${existingBackground ? 'Replace' : 'Upload'} Background Image</h5>
                                    <form id="upload-form-${channel.channel_id}" style="display: flex; gap: 10px; align-items: end;">
                                        <div style="flex: 1;">
                                            <input 
                                                type="file" 
                                                id="file-${channel.channel_id}"
                                                accept="image/*"
                                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                                onchange="previewBackgroundImage('${channel.channel_id}')"
                                            >
                                            <small style="color: #6c757d;">Max 10MB. Formats: JPG, PNG, GIF, WebP</small>
                                        </div>
                                        <button 
                                            type="button" 
                                            class="btn" 
                                            onclick="uploadChannelBackground('${channel.channel_id}', '${channelName}')"
                                            id="upload-btn-${channel.channel_id}"
                                        >
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                    </form>
                                    
                                    <div id="preview-${channel.channel_id}" style="margin-top: 15px; display: none;">
                                        <h5 style="margin: 0 0 10px 0; color: #495057;">Preview</h5>
                                        <div style="display: flex; gap: 20px;">
                                            <div>
                                                <p style="margin: 0 0 5px 0; font-size: 12px; color: #6c757d;">Color (Upcoming)</p>
                                                <div id="preview-color-${channel.channel_id}" style="
                                                    width: 150px; 
                                                    height: 90px; 
                                                    border-radius: 6px;
                                                    border: 2px solid #dee2e6;
                                                    background-size: cover;
                                                    background-position: center;
                                                "></div>
                                            </div>
                                            <div>
                                                <p style="margin: 0 0 5px 0; font-size: 12px; color: #6c757d;">B&W (Completed)</p>
                                                <div id="preview-bw-${channel.channel_id}" style="
                                                    width: 150px; 
                                                    height: 90px; 
                                                    border-radius: 6px;
                                                    border: 2px solid #dee2e6;
                                                    background-size: cover;
                                                    background-position: center;
                                                    filter: grayscale(100%);
                                                "></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            backgroundsHTML += `</div>`;
            contentDiv.innerHTML = backgroundsHTML;
        }

        function previewBackgroundImage(channelId) {
            const fileInput = document.getElementById(`file-${channelId}`);
            const previewDiv = document.getElementById(`preview-${channelId}`);
            const previewColor = document.getElementById(`preview-color-${channelId}`);
            const previewBW = document.getElementById(`preview-bw-${channelId}`);
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    previewColor.style.backgroundImage = `url("${imageUrl}")`;
                    previewBW.style.backgroundImage = `url("${imageUrl}")`;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                previewDiv.style.display = 'none';
            }
        }

        async function uploadChannelBackground(channelId, channelName) {
            const fileInput = document.getElementById(`file-${channelId}`);
            const uploadBtn = document.getElementById(`upload-btn-${channelId}`);
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select an image file first.');
                return;
            }

            const formData = new FormData();
            formData.append('backgroundImage', fileInput.files[0]);
            formData.append('channelId', channelId);
            formData.append('channelName', channelName);

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            try {
                const response = await fetch('/api/admin/channel-backgrounds/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show success message
                    const channelItem = document.querySelector(`[data-channel-id="${channelId}"]`);
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        background: #d4edda;
                        border: 1px solid #c3e6cb;
                        color: #155724;
                        padding: 10px;
                        border-radius: 4px;
                        margin-top: 10px;
                    `;
                    successMsg.innerHTML = `
                        <i class="fas fa-check"></i> Background uploaded successfully! Refresh the page to see updated interface.
                    `;
                    channelItem.appendChild(successMsg);

                    // Clear the file input
                    fileInput.value = '';
                    document.getElementById(`preview-${channelId}`).style.display = 'none';

                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                } else {
                    alert(`Error uploading background: ${data.message}`);
                }
            } catch (error) {
                console.error('Error uploading background:', error);
                alert('Network error occurred while uploading background.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload';
            }
        }

        async function deleteChannelBackground(channelId, channelName) {
            if (!confirm(`Are you sure you want to delete the background image for ${channelName}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/channel-backgrounds/${channelId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Reload the backgrounds to refresh the interface
                    loadChannelBackgrounds();
                } else {
                    alert(`Error deleting background: ${data.message}`);
                }
            } catch (error) {
                console.error('Error deleting background:', error);
                alert('Network error occurred while deleting background.');
            }
        }
    </script>
    </div>
</body>
</html> 