<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Points Management - Classic WoW Manager</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/admin-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Points Management Specific Styles */
        .reward-panel {
            background: var(--panel-bg, #ffffff);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(131, 168, 255, 0.15);
            transition: box-shadow 0.2s ease;
        }
        
        .dark .reward-panel {
            background: #1a1f2e;
            border-color: rgba(131, 168, 255, 0.25);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .reward-panel:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        .dark .reward-panel:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .reward-panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(131, 168, 255, 0.2);
        }
        
        .reward-panel-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }
        
        /* Compact number inputs */
        .admin-input-number {
            max-width: 120px;
            padding: 8px 12px;
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
        }
        
        .admin-input-array {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 10px 12px;
        }
        
        /* Input with badge (for units) */
        .input-with-badge {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 40px;
            justify-content: center;
        }
        
        .dark .input-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        /* Formula display */
        .formula-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            font-weight: 600;
            color: #4f46e5;
        }
        
        .dark .formula-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border-color: rgba(99, 102, 241, 0.4);
            color: #a5b4fc;
        }
        
        .formula-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6366f1;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .dark .formula-label {
            color: #818cf8;
        }
        
        /* Enhanced info boxes */
        .info-box-enhanced {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 16px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .dark .info-box-enhanced {
            background: rgba(59, 130, 246, 0.12);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .info-box-enhanced strong {
            color: #2563eb;
            font-weight: 700;
        }
        
        .dark .info-box-enhanced strong {
            color: #60a5fa;
        }
        
        /* Field labels */
        .field-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }
        
        .dark .field-label {
            color: #d1d5db;
        }
        
        .field-hint {
            display: block;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 6px;
            font-weight: 400;
        }
        
        .dark .field-hint {
            color: #9ca3af;
        }
        
        /* Tier indicator */
        .tier-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .tier-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tier-badge-1 { background: rgba(239, 68, 68, 0.15); color: #dc2626; }
        .tier-badge-2 { background: rgba(251, 191, 36, 0.15); color: #d97706; }
        .tier-badge-3 { background: rgba(34, 197, 94, 0.15); color: #16a34a; }
        
        .dark .tier-badge-1 { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .dark .tier-badge-2 { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .dark .tier-badge-3 { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        
        /* Sunder ranges table style */
        .sunder-ranges-table {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sunder-range-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            padding: 14px;
            border: 1px solid rgba(209, 213, 219, 0.3);
            border-radius: 8px;
            background: rgba(249, 250, 251, 0.5);
            transition: all 0.2s ease;
        }
        
        .dark .sunder-range-row {
            background: rgba(17, 24, 39, 0.5);
            border-color: rgba(75, 85, 99, 0.3);
        }
        
        .sunder-range-row:hover {
            background: rgba(243, 244, 246, 0.8);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .dark .sunder-range-row:hover {
            background: rgba(31, 41, 55, 0.8);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        /* Points array display */
        .points-array-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(243, 244, 246, 0.5);
            border-radius: 8px;
        }
        
        .dark .points-array-chips {
            background: rgba(17, 24, 39, 0.5);
        }
        
        .point-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border: 1px solid rgba(209, 213, 219, 0.5);
            border-radius: 6px;
            font-size: 0.85rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .dark .point-chip {
            background: #1f2937;
            border-color: rgba(75, 85, 99, 0.5);
        }
        
        .point-chip-position {
            font-size: 0.7rem;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .dark .point-chip-position {
            color: #9ca3af;
        }
        
        .point-chip-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #059669;
        }
        
        .dark .point-chip-value {
            color: #34d399;
        }
        
        /* Color preview swatch */
        .color-swatch {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            vertical-align: middle;
            margin-left: 6px;
        }
        
        .color-swatch.red { background-color: #ef4444; }
        .color-swatch.gray { background-color: #6b7280; }
        .color-swatch.green { background-color: #10b981; }
        .color-swatch.blue { background-color: #3b82f6; }
    </style>
    <script>
        // Initialize dark mode IMMEDIATELY (before page render) to prevent flash
        (function() {
            const stored = localStorage.getItem('admin-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (stored === 'dark' || (!stored && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <style>
        /* Minimal inline styles - most styling is in admin-styles.css */
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- Admin Navigation Bar -->
    <nav class="admin-nav-bar">
        <div class="admin-nav-container">
            <div class="admin-nav-content">
                <!-- Logo & Brand -->
                <div class="admin-nav-logo">
                    <img src="/images/1p_logo.png" alt="1Principles" width="110" height="30">
                    <span class="admin-nav-logo-text">Admin</span>
                </div>

                <!-- Navigation Links -->
                <div class="admin-nav-links">
                    <a href="/admin" class="admin-nav-link">
                        <i class="fas fa-home"></i> Admin Home
                    </a>
                    <a href="/admin/raid-channels" class="admin-nav-link">
                        <i class="fas fa-hashtag"></i> Raid Channels
                    </a>
                    <a href="/admin/points" class="admin-nav-link-active">
                        <i class="fas fa-trophy"></i> Points
                    </a>
                </div>

                <!-- Actions -->
                <div class="admin-nav-actions">
                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle" class="dark-mode-toggle-nav" aria-label="Toggle dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <!-- Exit Admin -->
                    <a href="/" class="admin-nav-exit-btn">
                        <i class="fas fa-sign-out-alt"></i> Exit Admin
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="admin-page-content bg-gray-50 dark:bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Points Management</h1>
                <p class="text-gray-600 dark:text-gray-400">Configure point calculations and limits for different raid performance categories</p>
            </div>

        <!-- Loading State -->
        <div id="loading" class="hidden">
            <div class="admin-card text-center py-12">
                <div class="loading-spinner mx-auto mb-4 text-blue-600"></div>
                <p class="text-gray-600 dark:text-gray-400">Loading...</p>
            </div>
        </div>

        <!-- Access Denied -->
        <div id="access-denied" class="hidden">
            <div class="admin-card bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800">
                <div class="text-center py-8">
                    <i class="fas fa-lock text-5xl text-red-600 dark:text-red-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-red-900 dark:text-red-200 mb-2">Access Denied</h2>
                    <p class="text-red-700 dark:text-red-300">You don't have permission to access this page. Please contact an administrator if you believe this is an error.</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="hidden space-y-8">
            <!-- Rewards and Deductions Section -->
            <section id="rewards-section" class="admin-card">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-2">
                        <i class="fas fa-trophy text-yellow-600"></i>
                        Rewards and Deductions
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Configure point calculations and limits for different raid performance categories.</p>
                </div>
                
                <div class="flex flex-wrap gap-3 mb-6">
                    <button class="admin-btn-primary hidden" onclick="saveRewardSettings()" id="save-rewards-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                
                <div id="rewards-content" class="min-h-[100px]">
                    <!-- Reward settings will be loaded here -->
                </div>
            </section>
        </div>
    </div>
    </div>

    <script src="/top-bar.js"></script>
    <script src="/admin-dark-mode.js"></script>
    <script>
        let currentUser = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            await initPage();
        });

        async function initPage() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const response = await fetch('/user');
                const user = await response.json();
                
                if (!user.loggedIn) {
                    showAccessDenied();
                    return;
                }
                
                currentUser = user;
                
                // Check if user has Management role
                if (!user.hasManagementRole) {
                    showAccessDenied();
                    return;
                }
                
                // User has Management role, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
                // Auto-load reward settings on page load
                await loadRewardSettings();
                
            } catch (error) {
                console.error('Error initializing page:', error);
                showAccessDenied();
            }
        }

        function showAccessDenied() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('access-denied').classList.remove('hidden');
        }

        // ==================== REWARDS SETTINGS SECTION ====================

        async function loadRewardSettings() {
            const contentDiv = document.getElementById('rewards-content');
            const saveBtn = document.getElementById('save-rewards-btn');
            
            contentDiv.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto mb-3"></div><p class="text-gray-600 dark:text-gray-400">Loading reward settings...</p></div>';

            try {
                const response = await fetch('/api/admin/reward-settings');
                const data = await response.json();

                if (response.ok && data.success) {
                    renderRewardSettings(data.settings);
                    saveBtn.style.display = 'inline-flex';
                } else {
                    contentDiv.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle mr-2"></i>Error loading settings: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading reward settings:', error);
                contentDiv.innerHTML = '<div class="alert-error"><i class="fas fa-exclamation-circle mr-2"></i>Network error occurred while loading settings.</div>';
            }
        }

        function renderRewardSettings(settings) {
            const contentDiv = document.getElementById('rewards-content');
            
            if (!settings || Object.keys(settings).length === 0) {
                contentDiv.innerHTML = `
                    <div class="alert-warning">
                        <h4 class="font-semibold mb-2"><i class="fas fa-inbox mr-2"></i>No Settings Found</h4>
                        <p class="mb-0">No reward settings found in the database. Please run database setup first.</p>
                    </div>
                `;
                return;
            }

            let settingsHTML = `
                <div class="admin-card-inner mb-6">
                    <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-3">‚öôÔ∏è Reward Configuration</h4>
                    <p class="text-gray-600 dark:text-gray-400 mb-0">
                        Configure how points are calculated and awarded for different performance categories.
                        <br><strong>Note:</strong> Changes take effect immediately on all raid logs pages.
                    </p>
                </div>
            `;

            // Abilities settings
            if (settings.abilities) {
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_bomb_06.jpg" style="width: 28px; height: 28px;"> 
                            <h4 class="reward-panel-title" style="color: #ff6b35;">Engineering & Holywater</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üí° Formula</div>
                            Points = floor((abilities used √ó avg targets) √∑ divisor), capped at maximum
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="field-label">
                                    Calculation Divisor
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="abilities-calculation-divisor" 
                                        value="${settings.abilities.calculation_divisor.value}" 
                                        min="1" 
                                        max="100" 
                                        step="0.1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">√∑</span>
                                </div>
                                <small class="field-hint">
                                    Higher divisor = fewer points awarded
                                </small>
                            </div>
                            
                            <div>
                                <label class="field-label">
                                    Maximum Points
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="abilities-max-points" 
                                        value="${settings.abilities.max_points.value}" 
                                        min="1" 
                                        max="500" 
                                        step="1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">pts</span>
                                </div>
                                <small class="field-hint">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Example:</strong> 10 sappers √ó 5 avg targets = 50 √∑ 10 divisor = 5 points (if max is 20)
                        </div>
                    </div>
                `;
            }

            // Damage settings
            if (settings.damage) {
                const damagePointsArray = settings.damage.points_array.value;
                let damageChips = '';
                damagePointsArray.forEach((pts, idx) => {
                    const position = idx + 1;
                    const suffix = position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th';
                    damageChips += `
                        <div class="point-chip">
                            <span class="point-chip-position">${position}${suffix}</span>
                            <span class="point-chip-value">${pts}</span>
                        </div>
                    `;
                });
                
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <i class="fas fa-sword" style="color: #dc2626; font-size: 24px;"></i>
                            <h4 class="reward-panel-title" style="color: #dc2626;">Damage Dealers</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üìä How It Works</div>
                            Rank players by total damage ‚Üí Award points based on position
                        </div>
                        
                        <div>
                            <label class="field-label">
                                Points for Each Position
                            </label>
                            <textarea 
                                id="damage-points-array" 
                                class="admin-input admin-input-array"
                                rows="2"
                                onchange="markRewardsChanged()"
                                placeholder="80, 70, 55, 40, 35, 30, 25, 20, 15, 10, 8, 6, 5, 4, 3"
                            >${damagePointsArray.join(', ')}</textarea>
                            <small class="field-hint">
                                Enter points separated by commas. Position 1 gets first value, position 2 gets second, etc.
                            </small>
                            
                            <div class="points-array-chips">
                                ${damageChips}
                            </div>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Current Setup:</strong> ${damagePointsArray.length} positions configured. Top DPS gets ${damagePointsArray[0]} points, 2nd place gets ${damagePointsArray[1]} points.
                        </div>
                    </div>
                `;
            }

            // Healing settings
            if (settings.healing) {
                const healingPointsArray = settings.healing.points_array.value;
                let healingChips = '';
                healingPointsArray.forEach((pts, idx) => {
                    const position = idx + 1;
                    const suffix = position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th';
                    healingChips += `
                        <div class="point-chip">
                            <span class="point-chip-position">${position}${suffix}</span>
                            <span class="point-chip-value">${pts}</span>
                        </div>
                    `;
                });
                
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <i class="fas fa-heart" style="color: #16a34a; font-size: 24px;"></i>
                            <h4 class="reward-panel-title" style="color: #16a34a;">Healers</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üìä How It Works</div>
                            Rank players by total healing ‚Üí Award points based on position
                        </div>
                        
                        <div>
                            <label class="field-label">
                                Points for Each Position
                            </label>
                            <textarea 
                                id="healing-points-array" 
                                class="admin-input admin-input-array"
                                rows="2"
                                onchange="markRewardsChanged()"
                                placeholder="80, 65, 60, 55, 40, 35, 30, 20, 15, 10"
                            >${healingPointsArray.join(', ')}</textarea>
                            <small class="field-hint">
                                Enter points separated by commas. Position 1 gets first value, position 2 gets second, etc.
                            </small>
                            
                            <div class="points-array-chips">
                                ${healingChips}
                            </div>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Current Setup:</strong> ${healingPointsArray.length} positions configured. Top healer gets ${healingPointsArray[0]} points, 2nd place gets ${healingPointsArray[1]} points.
                        </div>
                    </div>
                `;
            }

            // Mana Potions settings
            if (settings.mana_potions) {
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_potion_76.jpg" style="width: 28px; height: 28px;"> 
                            <h4 class="reward-panel-title" style="color: #4a9eff;">Major Mana Potions</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üí° Formula</div>
                            Points = min(max_points, floor((potions_used - threshold) √∑ 3))
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="field-label">
                                    Minimum Threshold
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="mana-threshold" 
                                        value="${settings.mana_potions.threshold.value}" 
                                        min="0" 
                                        max="100" 
                                        step="1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">üß™</span>
                                </div>
                                <small class="field-hint">
                                    Potions below this = 0 points
                                </small>
                            </div>
                            
                            <div>
                                <label class="field-label">
                                    Points Per Potion
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="mana-points-per-potion" 
                                        value="${settings.mana_potions.points_per_potion.value}" 
                                        min="0.1" 
                                        max="50" 
                                        step="0.1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">pts</span>
                                </div>
                                <small class="field-hint">
                                    Points earned per potion
                                </small>
                            </div>
                            
                            <div>
                                <label class="field-label">
                                    Maximum Points
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="mana-max-points" 
                                        value="${settings.mana_potions.max_points.value}" 
                                        min="1" 
                                        max="500" 
                                        step="1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">max</span>
                                </div>
                                <small class="field-hint">
                                    Points capped at this value
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Example:</strong> With threshold ${settings.mana_potions.threshold.value}, using 15 potions = (15 - ${settings.mana_potions.threshold.value}) √∑ 3 = ${Math.floor((15 - settings.mana_potions.threshold.value) / 3)} points
                        </div>
                    </div>
                `;
            }

            // Runes settings
            if (settings.runes) {
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_sealofkings.jpg" style="width: 28px; height: 28px;"> 
                            <h4 class="reward-panel-title" style="color: #9333ea;">Dark or Demonic Runes</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üí° Formula</div>
                            Points = floor(total_runes √∑ ${settings.runes.usage_divisor.value}) √ó ${settings.runes.points_per_division.value}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="field-label">
                                    Points Earned <span style="color: #9333ea;">(X)</span>
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="runes-points-earned" 
                                        value="${settings.runes.points_per_division.value}" 
                                        min="0.1" 
                                        max="10" 
                                        step="0.1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">pts</span>
                                </div>
                                <small class="field-hint">
                                    Points per threshold reached
                                </small>
                            </div>
                            
                            <div>
                                <label class="field-label">
                                    Runes Needed <span style="color: #9333ea;">(Y)</span>
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="runes-threshold" 
                                        value="${settings.runes.usage_divisor.value}" 
                                        min="1" 
                                        max="20" 
                                        step="1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">ü™®</span>
                                </div>
                                <small class="field-hint">
                                    Runes per point threshold
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Example:</strong> ${settings.runes.points_per_division.value} point per ${settings.runes.usage_divisor.value} runes ‚Üí 2 runes = 1 point, 4 runes = 2 points, 5 runes = 2 points
                        </div>
                    </div>
                `;
            }

            // Interrupts settings
            if (settings.interrupts) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold text-yellow-600 dark:text-yellow-400 mb-4 flex items-center gap-3">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_kick.jpg" style="width: 20px; height: 20px;"> 
                            Interrupted spells
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    You get <span class="text-yellow-600 dark:text-yellow-400">X</span> points
                                </label>
                                <input 
                                    type="number" 
                                    id="interrupts-points-earned" 
                                    value="${settings.interrupts.points_per_interrupt.value}" 
                                    min="0.1" 
                                    max="10" 
                                    step="0.1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points awarded per interrupt threshold reached
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Per <span class="text-yellow-600 dark:text-yellow-400">Y</span> interrupts
                                </label>
                                <input 
                                    type="number" 
                                    id="interrupts-threshold" 
                                    value="${settings.interrupts.interrupts_needed.value}" 
                                    min="1" 
                                    max="10" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Number of interrupts needed to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Maximum Points
                                </label>
                                <input 
                                    type="number" 
                                    id="interrupts-max-points" 
                                    value="${settings.interrupts.max_points.value}" 
                                    min="1" 
                                    max="50" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-blue">
                            <strong>Example:</strong> If you set "1 point per 1 interrupt, max 5", then 1 interrupt = 1 point, 5 interrupts = 5 points, 8 interrupts = 5 points (capped)
                            <br><strong>Formula:</strong> Points = min(max_points, floor(interrupts √∑ threshold) √ó points_earned)
                        </div>
                    </div>
                `;
            }

            // Disarms settings
            if (settings.disarms) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold text-red-600 dark:text-red-400 mb-4 flex items-center gap-3">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_warrior_disarm.jpg" style="width: 20px; height: 20px;"> 
                            Disarmed enemies
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    You get <span class="text-red-600 dark:text-red-400">X</span> points
                                </label>
                                <input 
                                    type="number" 
                                    id="disarms-points-earned" 
                                    value="${settings.disarms.points_per_disarm.value}" 
                                    min="0.1" 
                                    max="10" 
                                    step="0.1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points awarded per disarm threshold reached
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Per <span class="text-red-600 dark:text-red-400">Y</span> disarms
                                </label>
                                <input 
                                    type="number" 
                                    id="disarms-threshold" 
                                    value="${settings.disarms.disarms_needed.value}" 
                                    min="1" 
                                    max="10" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Number of disarms needed to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Maximum Points
                                </label>
                                <input 
                                    type="number" 
                                    id="disarms-max-points" 
                                    value="${settings.disarms.max_points.value}" 
                                    min="1" 
                                    max="50" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points are capped at this maximum value
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-blue">
                            <strong>Example:</strong> If you set "1 point per 1 disarm, max 5", then 1 disarm = 1 point, 5 disarms = 5 points, 8 disarms = 5 points (capped)
                            <br><strong>Formula:</strong> Points = min(max_points, floor(disarms √∑ threshold) √ó points_earned)
                        </div>
                    </div>
                `;
            }

            // Sunder Armor settings
            if (settings.sunder) {
                const ranges = settings.sunder.point_ranges.value || [];
                let rangesHTML = '';
                
                ranges.forEach((range, index) => {
                    rangesHTML += `
                        <div class="sunder-range-row">
                            <div>
                                <label class="field-label" style="font-size: 0.75rem; margin-bottom: 4px;">Min Count</label>
                                <input 
                                    type="number" 
                                    id="sunder-range-${index}-min" 
                                    value="${range.min}" 
                                    min="0" 
                                    max="999"
                                    class="admin-input admin-input-number"
                                    style="max-width: 100px;"
                                    onchange="markRewardsChanged()"
                                >
                            </div>
                            <div>
                                <label class="field-label" style="font-size: 0.75rem; margin-bottom: 4px;">Max Count</label>
                                <input 
                                    type="number" 
                                    id="sunder-range-${index}-max" 
                                    value="${range.max}" 
                                    min="0" 
                                    max="999"
                                    class="admin-input admin-input-number"
                                    style="max-width: 100px;"
                                    onchange="markRewardsChanged()"
                                >
                            </div>
                            <div>
                                <label class="field-label" style="font-size: 0.75rem; margin-bottom: 4px;">Points</label>
                                <input 
                                    type="number" 
                                    id="sunder-range-${index}-points" 
                                    value="${range.points}" 
                                    min="-50" 
                                    max="50"
                                    class="admin-input admin-input-number"
                                    style="max-width: 100px;"
                                    onchange="markRewardsChanged()"
                                >
                            </div>
                            <div>
                                <label class="field-label" style="font-size: 0.75rem; margin-bottom: 4px;">Color <span class="color-swatch ${range.color}"></span></label>
                                <select 
                                    id="sunder-range-${index}-color" 
                                    class="admin-select"
                                    style="padding: 0.5rem 0.75rem; font-size: 0.875rem;"
                                    onchange="markRewardsChanged()"
                                >
                                    <option value="red" ${range.color === 'red' ? 'selected' : ''}>Red</option>
                                    <option value="gray" ${range.color === 'gray' ? 'selected' : ''}>Gray</option>
                                    <option value="green" ${range.color === 'green' ? 'selected' : ''}>Green</option>
                                    <option value="blue" ${range.color === 'blue' ? 'selected' : ''}>Blue</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_warrior_sunder.jpg" style="width: 28px; height: 28px;"> 
                            <h4 class="reward-panel-title" style="color: #9333ea;">Sunder Armor</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üìä How It Works</div>
                            Points awarded based on Sunder Armor count falling into configured ranges
                        </div>
                        
                        <div class="mb-4">
                            <label class="field-label">
                                Point Ranges
                            </label>
                            <div class="sunder-ranges-table" id="sunder-ranges-container">
                                ${rangesHTML}
                            </div>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Example:</strong> If a player has ${ranges[2]?.min || 100} sunders, they fall in the ${ranges[2]?.min || 100}-${ranges[2]?.max || 119} range and get ${ranges[2]?.points || 5} points.
                        </div>
                    </div>
                `;
            }

            // Curse of Recklessness settings
            if (settings.curse) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-4 flex items-center gap-3">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_unholystrength.jpg" style="width: 24px; height: 24px;"> 
                            Curse of Recklessness
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-uptime-threshold" 
                                    value="${settings.curse.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-points" 
                                    value="${settings.curse.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-purple">
                            <strong>Description:</strong> ${settings.curse.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Curse of Shadow settings
            if (settings.curse_shadow) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-4 flex items-center gap-3">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_curseofachimonde.jpg" style="width: 24px; height: 24px;"> 
                            Curse of Shadow
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-shadow-uptime-threshold" 
                                    value="${settings.curse_shadow.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-shadow-points" 
                                    value="${settings.curse_shadow.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-purple">
                            <strong>Description:</strong> ${settings.curse_shadow.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Curse of the Elements settings
            if (settings.curse_elements) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold text-blue-600 dark:text-blue-400 mb-4 flex items-center gap-3">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_chilltouch.jpg" style="width: 24px; height: 24px;"> 
                            Curse of the Elements
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-elements-uptime-threshold" 
                                    value="${settings.curse_elements.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="curse-elements-points" 
                                    value="${settings.curse_elements.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-blue">
                            <strong>Description:</strong> ${settings.curse_elements.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Faerie Fire settings
            if (settings.faerie_fire) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold text-green-600 dark:text-green-400 mb-4 flex items-center gap-3">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_nature_faeriefire.jpg" style="width: 24px; height: 24px;"> 
                            Faerie Fire
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Uptime Threshold (%)
                                </label>
                                <input 
                                    type="number" 
                                    id="faerie-fire-uptime-threshold" 
                                    value="${settings.faerie_fire.uptime_threshold.value}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Players need more than this % uptime to earn points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Points Awarded
                                </label>
                                <input 
                                    type="number" 
                                    id="faerie-fire-points" 
                                    value="${settings.faerie_fire.points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points given to players above threshold
                                </small>
                            </div>
                        </div>
                        
                        <div class="info-box-blue">
                            <strong>Description:</strong> ${settings.faerie_fire.uptime_threshold.description}
                        </div>
                    </div>
                `;
            }

            // Scorch settings
            if (settings.scorch) {
                settingsHTML += `
                    <div class="reward-panel">
                        <div class="reward-panel-header">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/spell_fire_soulburn.jpg" style="width: 28px; height: 28px;"> 
                            <h4 class="reward-panel-title" style="color: #dc2626;">Scorch</h4>
                        </div>
                        
                        <div class="formula-box">
                            <div class="formula-label">üìä Tier System</div>
                            0-${settings.scorch.tier1_max.value} = 0 pts ‚Ä¢ ${settings.scorch.tier1_max.value + 1}-${settings.scorch.tier2_max.value} = ${settings.scorch.tier2_points.value} pts ‚Ä¢ ${settings.scorch.tier2_max.value + 1}+ = ${settings.scorch.tier3_points.value} pts
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <div class="tier-container">
                                    <span class="tier-badge tier-badge-1">Tier 1</span>
                                    <span style="font-size: 0.85rem; color: #6b7280;">0 points</span>
                                </div>
                                <label class="field-label">
                                    Maximum Count
                                </label>
                                <div class="input-with-badge">
                                    <input 
                                        type="number" 
                                        id="scorch-tier1-max" 
                                        value="${settings.scorch.tier1_max.value}" 
                                        min="0" 
                                        max="999" 
                                        step="1"
                                        class="admin-input admin-input-number"
                                        onchange="markRewardsChanged()"
                                    >
                                    <span class="input-badge">max</span>
                                </div>
                                <small class="field-hint">
                                    Scorches 0-${settings.scorch.tier1_max.value} = 0 points
                                </small>
                            </div>
                            
                            <div>
                                <div class="tier-container">
                                    <span class="tier-badge tier-badge-2">Tier 2</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="field-label">Max Count</label>
                                        <input 
                                            type="number" 
                                            id="scorch-tier2-max" 
                                            value="${settings.scorch.tier2_max.value}" 
                                            min="0" 
                                            max="999" 
                                            step="1"
                                            class="admin-input admin-input-number"
                                            style="max-width: 100px;"
                                            onchange="markRewardsChanged()"
                                        >
                                    </div>
                                    <div>
                                        <label class="field-label">Points</label>
                                        <div class="input-with-badge">
                                            <input 
                                                type="number" 
                                                id="scorch-tier2-points" 
                                                value="${settings.scorch.tier2_points.value}" 
                                                min="0" 
                                                max="100" 
                                                step="1"
                                                class="admin-input admin-input-number"
                                                style="max-width: 80px;"
                                                onchange="markRewardsChanged()"
                                            >
                                            <span class="input-badge">pts</span>
                                        </div>
                                    </div>
                                </div>
                                <small class="field-hint">
                                    Scorches ${settings.scorch.tier1_max.value + 1}-${settings.scorch.tier2_max.value} = ${settings.scorch.tier2_points.value} points
                                </small>
                            </div>
                        </div>
                        
                        <div>
                            <div class="tier-container">
                                <span class="tier-badge tier-badge-3">Tier 3</span>
                                <span style="font-size: 0.85rem; color: #16a34a; font-weight: 600;">Highest Tier</span>
                            </div>
                            <label class="field-label">
                                Points Awarded
                            </label>
                            <div class="input-with-badge">
                                <input 
                                    type="number" 
                                    id="scorch-tier3-points" 
                                    value="${settings.scorch.tier3_points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    class="admin-input admin-input-number"
                                    onchange="markRewardsChanged()"
                                >
                                <span class="input-badge">pts</span>
                            </div>
                            <small class="field-hint">
                                Scorches ${settings.scorch.tier2_max.value + 1}+ = ${settings.scorch.tier3_points.value} points
                            </small>
                        </div>
                        
                        <div class="info-box-enhanced">
                            <strong>üí° Example:</strong> If a player casts 150 Scorches, they're in Tier 2 and get ${settings.scorch.tier2_points.value} points.
                        </div>
                    </div>
                `;
            }

            // Demoralizing Shout settings
            if (settings.demo_shout) {
                settingsHTML += `
                    <div class="admin-card-inner mb-6">
                        <h4 class="text-lg font-bold mb-4 flex items-center gap-3" style="color: #d2691e;">
                            <img src="https://wow.zamimg.com/images/wow/icons/large/ability_warrior_warcry.jpg" style="width: 24px; height: 24px;"> 
                            Demoralizing Shout
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Tier 1 Max (0 points)
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier1-max" 
                                    value="${settings.demo_shout.tier1_max.value}" 
                                    min="0" 
                                    max="999" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Max demo shout count for 0 points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Tier 2 Max
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier2-max" 
                                    value="${settings.demo_shout.tier2_max.value}" 
                                    min="0" 
                                    max="999" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Max for tier 2 points
                                </small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                    Tier 2 Points
                                </label>
                                <input 
                                    type="number" 
                                    id="demo-shout-tier2-points" 
                                    value="${settings.demo_shout.tier2_points.value}" 
                                    min="0" 
                                    max="100" 
                                    step="1"
                                    class="admin-input"
                                    onchange="markRewardsChanged()"
                                >
                                <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                    Points for mid-tier
                                </small>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                                Tier 3 Points (High Tier)
                            </label>
                            <input 
                                type="number" 
                                id="demo-shout-tier3-points" 
                                value="${settings.demo_shout.tier3_points.value}" 
                                min="0" 
                                max="100" 
                                step="1"
                                class="admin-input"
                                onchange="markRewardsChanged()"
                            >
                            <small class="text-gray-500 dark:text-gray-400 text-xs block mt-2">
                                Points for highest tier (above tier 2 max)
                            </small>
                        </div>
                        
                        <div class="info-box-blue">
                            <strong>Description:</strong> ${settings.demo_shout.tier1_max.description}
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = settingsHTML;
        }

        function markRewardsChanged() {
            document.getElementById('save-rewards-btn').style.display = 'inline-flex';
        }

        function collectSunderRanges() {
        const ranges = [];
        const container = document.getElementById('sunder-ranges-container');
        if (!container) return ranges;
        
        const rangeElements = container.querySelectorAll('[id^="sunder-range-"]');
        const rangeIndexes = new Set();
        
        // Extract unique range indexes
        rangeElements.forEach(element => {
            const match = element.id.match(/sunder-range-(\d+)-/);
            if (match) {
                rangeIndexes.add(parseInt(match[1]));
            }
        });
        
        // Collect data for each range
        rangeIndexes.forEach(index => {
            const minElement = document.getElementById(`sunder-range-${index}-min`);
            const maxElement = document.getElementById(`sunder-range-${index}-max`);
            const pointsElement = document.getElementById(`sunder-range-${index}-points`);
            const colorElement = document.getElementById(`sunder-range-${index}-color`);
            
            if (minElement && maxElement && pointsElement && colorElement) {
                ranges.push({
                    min: parseInt(minElement.value),
                    max: parseInt(maxElement.value),
                    points: parseInt(pointsElement.value),
                    color: colorElement.value
                });
            }
        });
        
        // Sort ranges by min value
        ranges.sort((a, b) => a.min - b.min);
        
        return ranges;
    }

    async function saveRewardSettings() {
            const saveBtn = document.getElementById('save-rewards-btn');
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            // Helper function to parse array from textarea
            function parsePointsArray(textareaId) {
                const text = document.getElementById(textareaId).value.trim();
                if (!text) return [];
                return text.split(',').map(val => parseInt(val.trim())).filter(val => !isNaN(val));
            }

            // Collect settings from form
            const settings = {
                abilities: {
                    calculation_divisor: parseFloat(document.getElementById('abilities-calculation-divisor').value),
                    max_points: parseInt(document.getElementById('abilities-max-points').value)
                },
                damage: {
                    points_array: parsePointsArray('damage-points-array')
                },
                healing: {
                    points_array: parsePointsArray('healing-points-array')
                },
                mana_potions: {
                    threshold: parseInt(document.getElementById('mana-threshold').value),
                    points_per_potion: parseFloat(document.getElementById('mana-points-per-potion').value),
                    max_points: parseInt(document.getElementById('mana-max-points').value)
                },
                runes: {
                    usage_divisor: parseInt(document.getElementById('runes-threshold').value),
                    points_per_division: parseFloat(document.getElementById('runes-points-earned').value)
                },
                interrupts: {
                    points_per_interrupt: parseFloat(document.getElementById('interrupts-points-earned').value),
                    interrupts_needed: parseInt(document.getElementById('interrupts-threshold').value),
                    max_points: parseInt(document.getElementById('interrupts-max-points').value)
                },
                disarms: {
                    points_per_disarm: parseFloat(document.getElementById('disarms-points-earned').value),
                    disarms_needed: parseInt(document.getElementById('disarms-threshold').value),
                    max_points: parseInt(document.getElementById('disarms-max-points').value)
                },
                sunder: {
                    point_ranges: collectSunderRanges()
                },
                curse: {
                    uptime_threshold: parseFloat(document.getElementById('curse-uptime-threshold').value),
                    points: parseInt(document.getElementById('curse-points').value)
                },
                curse_shadow: {
                    uptime_threshold: parseFloat(document.getElementById('curse-shadow-uptime-threshold').value),
                    points: parseInt(document.getElementById('curse-shadow-points').value)
                },
                curse_elements: {
                    uptime_threshold: parseFloat(document.getElementById('curse-elements-uptime-threshold').value),
                    points: parseInt(document.getElementById('curse-elements-points').value)
                }
            };

            // Only include settings if the corresponding input fields exist (defensive checks)
            const faerieFireThreshold = document.getElementById('faerie-fire-uptime-threshold');
            if (faerieFireThreshold) {
                settings.faerie_fire = {
                    uptime_threshold: parseFloat(faerieFireThreshold.value),
                    points: parseInt(document.getElementById('faerie-fire-points').value)
                };
            }

            const scorchTier1Max = document.getElementById('scorch-tier1-max');
            if (scorchTier1Max) {
                settings.scorch = {
                    tier1_max: parseInt(scorchTier1Max.value),
                    tier1_points: 0, // Always 0 for tier 1
                    tier2_max: parseInt(document.getElementById('scorch-tier2-max').value),
                    tier2_points: parseInt(document.getElementById('scorch-tier2-points').value),
                    tier3_points: parseInt(document.getElementById('scorch-tier3-points').value)
                };
            }

            const demoShoutTier1Max = document.getElementById('demo-shout-tier1-max');
            if (demoShoutTier1Max) {
                settings.demo_shout = {
                    tier1_max: parseInt(demoShoutTier1Max.value),
                    tier1_points: 0, // Always 0 for tier 1
                    tier2_max: parseInt(document.getElementById('demo-shout-tier2-max').value),
                    tier2_points: parseInt(document.getElementById('demo-shout-tier2-points').value),
                    tier3_points: parseInt(document.getElementById('demo-shout-tier3-points').value)
                };
            }

            try {
                const response = await fetch('/api/admin/reward-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        settings: settings
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show success message
                    const contentDiv = document.getElementById('rewards-content');
                    const successMsg = document.createElement('div');
                    successMsg.className = 'alert-success';
                    successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Reward settings have been updated successfully! Changes are now active on all raid logs pages.';
                    contentDiv.insertBefore(successMsg, contentDiv.firstChild);

                    // Remove success message after 4 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 4000);

                    saveBtn.style.display = 'none';
                } else {
                    alert(`Error saving settings: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving reward settings:', error);
                alert('Network error occurred while saving settings.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }
    </script>
</body>
</html>
